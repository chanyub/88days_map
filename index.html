<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>88 Days Map Australia - Working Holiday Visa Regional Work Areas | 호주워홀 세컨비자 지도 | Find Eligible Postcodes</title>
  
  <!-- SEO Meta Tags -->
  <meta name="description" content="Complete interactive map of Australian Working Holiday Visa 88-day regional work areas. Find eligible postcodes for agriculture, hospitality, tourism jobs. Free tool for subclass 417 visa holders. 호주 워킹홀리데이 88일 지역 근무 지역 완전한 인터랙티브 지도. 세컨비자를 위한 농업, 접객업, 관광업 일자리 우편번호 찾기."/>
  <meta name="keywords" content="working holiday visa 88 days, australian working holiday areas, 88 days map australia, working holiday postcode, australia regional work visa, subclass 417 visa, working holiday jobs australia, backpacker jobs australia, australian visa requirements, working holiday visa extension, regional australia jobs, australia postcode map, working holiday visa guide, 호주워홀 세컨, 세컨비자, 호주워홀, 세컨지도, 세컨비자 지도, 호주 워킹홀리데이 88일, 호주 지역지 근무, 호주 농장일자리, 호주 백패커 일자리, 호주 워홀비자, 세컨비자 조건, 호주 워킹홀리데이 연장"/>
  <meta name="author" content="하고싶은게많은"/>
  <meta name="robots" content="index, follow, max-snippet:-1, max-video-preview:-1, max-image-preview:large"/>
  <meta name="googlebot" content="index, follow"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="canonical" href="https://chanyub.github.io/88days_map/"/>
  <link rel="alternate" hreflang="en" href="https://chanyub.github.io/88days_map/"/>
  <link rel="alternate" hreflang="ko" href="https://chanyub.github.io/88days_map/"/>
  <link rel="alternate" hreflang="x-default" href="https://chanyub.github.io/88days_map/"/>
  
  <!-- Structured Data for Search Engines -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "88 Days Map Australia - 호주워홀 세컨비자 지도",
    "description": "Interactive map showing eligible work areas for Australian Working Holiday visa holders to complete their 88-day requirement. 호주 워킹홀리데이 88일 세컨비자 지역 근무 인터랙티브 지도",
    "url": "https://chanyub.github.io/88days_map/",
    "applicationCategory": "UtilityApplication",
    "operatingSystem": "Any",
    "offers": {
      "@type": "Offer",
      "price": "0",
      "priceCurrency": "USD"
    },
    "creator": {
      "@type": "Person",
      "name": "하고싶은게많은",
      "url": "https://www.youtube.com/@%ED%95%98%EA%B3%A0%EC%8B%B6%EC%9D%80%EA%B2%8C%EB%A7%8E%EC%9D%80"
    },
    "about": {
      "@type": "Thing",
      "name": "Working Holiday Visa Australia - 호주워홀 세컨비자",
      "description": "Australian Working Holiday Visa 88-day regional work requirement. 호주 워킹홀리데이 88일 지역 근무 조건"
    },
    "inLanguage": ["en", "ko"],
    "audience": {
      "@type": "Audience",
      "audienceType": "Working Holiday Visa Holders"
    }
  }
  </script>
  
  <!-- Open Graph / Social Media Meta Tags -->
  <meta property="og:title" content="88 Days Map Australia - 호주워홀 세컨비자 지도 - Working Holiday Visa Regional Work Areas"/>
  <meta property="og:description" content="Complete interactive map of Australian Working Holiday Visa 88-day regional work areas. Find eligible postcodes for agriculture, hospitality, tourism jobs. 호주 워킹홀리데이 88일 세컨비자 지역 근무 지도."/>
  <meta property="og:image" content="https://chanyub.github.io/88days_map/thumbnail.svg"/>
  <meta property="og:url" content="https://chanyub.github.io/88days_map/"/>
  <meta property="og:type" content="website"/>
  <meta property="og:site_name" content="88 Days Map Australia"/>
  <meta property="og:locale" content="en_US"/>
  <meta property="og:locale:alternate" content="ko_KR"/>
  
  <!-- Twitter Card Meta Tags -->
  <meta name="twitter:card" content="summary_large_image"/>
  <meta name="twitter:title" content="88 Days Map Australia - 호주워홀 세컨비자 지도 - Working Holiday Visa Regional Work Areas"/>
  <meta name="twitter:description" content="Complete interactive map of Australian Working Holiday Visa 88-day regional work areas. Find eligible postcodes for agriculture, hospitality, tourism jobs. 호주 워킹홀리데이 88일 세컨비자 지역 근무 지도."/>
  <meta name="twitter:image" content="https://chanyub.github.io/88days_map/thumbnail.svg"/>
  <meta name="twitter:site" content="@88DaysMap"/>
  
  <!-- Additional SEO Meta Tags -->
  <meta name="theme-color" content="#4a90e2"/>
  <meta name="msapplication-TileColor" content="#4a90e2"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="default"/>
  <meta name="apple-mobile-web-app-title" content="88 Days Map"/>
  
  <!-- Geo Tags -->
  <meta name="geo.region" content="AU"/>
  <meta name="geo.country" content="Australia"/>
  <meta name="ICBM" content="-25.274398, 133.775136"/>
  <meta name="geo.position" content="-25.274398;133.775136"/>
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json"/>
  
  <!-- Favicon and Icons -->
  <link rel="icon" type="image/svg+xml" href="thumbnail.svg"/>
  <link rel="apple-touch-icon" href="thumbnail.svg"/>
  
  <!-- Preload critical resources -->
  <link rel="preload" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" as="style"/>
  <link rel="preload" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" as="script"/>
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  
  <!-- Google Analytics (GA4) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    // Replace G-XXXXXXXXXX with your actual Google Analytics ID
    // gtag('config', 'G-XXXXXXXXXX');
  </script>
  
  <!-- Firebase Real-time Chat -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getDatabase, ref, push, onValue, serverTimestamp, limitToLast, query, set, runTransaction } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
    
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAXKhKl6tnlyKZ84YXyZRJXoIbXRpXRgAA",
      authDomain: "palpalzones.firebaseapp.com",
      databaseURL: "https://palpalzones-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "palpalzones",
      storageBucket: "palpalzones.firebasestorage.app",
      messagingSenderId: "164023944108",
      appId: "1:164023944108:web:f6f8e0707951e0757f3009",
      measurementId: "G-6QG5JB2X63"
    };
    
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    
    // Make Firebase functions available globally
    window.firebaseDB = database;
    window.firebaseRef = ref;
    window.firebasePush = push;
    window.firebaseOnValue = onValue;
    window.firebaseServerTimestamp = serverTimestamp;
    window.firebaseQuery = query;
    window.firebaseLimitToLast = limitToLast;
    window.firebaseSet = set;
    window.firebaseRunTransaction = runTransaction;
    
    // Enable real-time chat
    window.chatBackend = {
      enabled: true,
      database: database
    };
    
    // Enable region comments system
    window.commentsSystem = {
      enabled: true,
      database: database
    };
    
    console.log('🔥 Firebase initialized successfully!');
  </script>
  <style>
    html,body,#map{height:100%;margin:0}
    #search-container{position:absolute;top:10px;left:50%;transform:translateX(-50%);z-index:1000;background:white;padding:10px;border-radius:5px;box-shadow:0 2px 5px rgba(0,0,0,0.2)}
    #search-input{padding:5px;width:200px;border:1px solid #ccc;border-radius:3px}
    #search-results{max-height:200px;overflow-y:auto;background:white;border:1px solid #ccc;border-top:none;display:none}
    .search-result{padding:8px;cursor:pointer;border-bottom:1px solid #eee}
    .search-result:hover{background:#f0f0f0}
    #visitor-stats{position:absolute;bottom:10px;right:10px;z-index:1000;background:rgba(255,255,255,0.9);padding:8px;border-radius:5px;font-size:12px;font-family:Arial,sans-serif}
    .stat-line{margin:2px 0}
    #legend{position:absolute;top:60px;left:10px;z-index:1000;background:rgba(255,255,255,0.95);padding:15px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,0.3);max-width:350px;font-family:Arial,sans-serif;font-size:13px}
    .legend-title{font-weight:bold;font-size:16px;margin-bottom:10px;color:#333}
    .legend-item{display:flex;align-items:center;margin:8px 0;cursor:pointer}
    .legend-item:hover{background:#f5f5f5;border-radius:4px;padding:4px}
    .legend-color{width:20px;height:15px;margin-right:10px;border:1px solid #333;border-radius:3px}
    .legend-text{flex:1;line-height:1.3}
    .legend-category{font-weight:bold;color:#444}
    .legend-source{margin-top:15px;padding-top:10px;border-top:1px solid #ddd;font-size:11px;color:#666}
    .legend-source a{color:#0066cc;text-decoration:none}
    .legend-source a:hover{text-decoration:underline}
    #info-panel{position:absolute;top:10px;right:10px;z-index:1001;background:rgba(255,255,255,0.95);padding:15px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,0.3);max-width:400px;font-family:Arial,sans-serif;font-size:13px;display:none}
    .info-title{font-weight:bold;font-size:16px;margin-bottom:10px;color:#333}
    .info-content{line-height:1.5}
    .close-btn{float:right;cursor:pointer;font-size:18px;color:#666}
    .close-btn:hover{color:#000}
    #loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:9999;display:flex;justify-content:center;align-items:center;color:white;font-family:Arial,sans-serif}
    .spinner{border:4px solid #f3f3f3;border-top:4px solid #3498db;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin-right:15px}
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
    .loading-text{font-size:18px}
    #chat-container{position:absolute;bottom:10px;left:10px;z-index:1000;width:300px;background:rgba(255,255,255,0.95);border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,0.3);font-family:Arial,sans-serif;font-size:12px}
    #chat-header{background:#4a90e2;color:white;padding:8px 12px;border-radius:8px 8px 0 0;font-weight:bold;cursor:pointer;user-select:none}
    #chat-content{display:none;max-height:200px;border:1px solid #ddd;border-top:none}
    #chat-messages{height:150px;overflow-y:auto;padding:8px;background:white}
    .message{margin:4px 0;padding:4px 6px;background:#f8f9fa;border-radius:4px;word-wrap:break-word}
    .message-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:2px}
    .message-author{font-weight:bold;color:#333;font-size:11px}
    .message-time{font-size:10px;color:#666}
    .message-text{font-size:11px;line-height:1.3}
    #chat-input-container{padding:8px;background:#f5f5f5;border-radius:0 0 8px 8px}
    .input-row{display:flex;gap:5px;margin-bottom:5px}
    #username-input{width:80px;padding:4px;border:1px solid #ddd;border-radius:3px;font-size:11px}
    #chat-input{flex:1;padding:4px;border:1px solid #ddd;border-radius:3px;font-size:11px}
    #chat-send{padding:4px 8px;background:#4a90e2;color:white;border:none;border-radius:3px;cursor:pointer;font-size:11px}
    #chat-send:hover{background:#357abd}
    .chat-collapsed{opacity:0.8}
    #creator-info{position:absolute;bottom:10px;right:130px;z-index:1000;background:rgba(255,255,255,0.9);padding:6px 8px;border-radius:5px;font-size:10px;font-family:Arial,sans-serif;color:#666;box-shadow:0 1px 3px rgba(0,0,0,0.2)}
    #creator-info a{color:#4a90e2;text-decoration:none;margin:0 2px}
    #creator-info a:hover{text-decoration:underline}
    .creator-line{margin:1px 0}
    
    /* Comment Modal Styles */
    #comment-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:10000;display:none;justify-content:center;align-items:center;font-family:Arial,sans-serif}
    .modal-content{background:white;padding:20px;border-radius:10px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto;position:relative}
    .modal-header{border-bottom:1px solid #eee;padding-bottom:15px;margin-bottom:15px}
    .modal-title{font-size:18px;font-weight:bold;color:#333;margin:0}
    .close-modal{position:absolute;top:15px;right:15px;background:none;border:none;font-size:24px;cursor:pointer;color:#666}
    .close-modal:hover{color:#000}
    .comment-form{margin-bottom:20px}
    .form-group{margin-bottom:15px}
    .form-group label{display:block;margin-bottom:5px;font-weight:bold;color:#333}
    .form-group input,.form-group textarea{width:100%;padding:8px;border:1px solid #ddd;border-radius:5px;font-size:14px;box-sizing:border-box}
    .form-group textarea{resize:vertical;min-height:80px}
    .btn-primary{background:#4a90e2;color:white;border:none;padding:10px 20px;border-radius:5px;cursor:pointer;font-size:14px}
    .btn-primary:hover{background:#357abd}
    .comments-list{max-height:300px;overflow-y:auto}
    .comment-item{border:1px solid #eee;border-radius:5px;padding:10px;margin-bottom:10px;background:#fafafa}
    .comment-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .comment-author{font-weight:bold;color:#333}
    .comment-time{font-size:11px;color:#666}
    .comment-text{line-height:1.4;color:#444}
    .comment-actions{margin-top:8px;text-align:right}
    .btn-small{background:none;border:1px solid #ddd;padding:3px 8px;border-radius:3px;cursor:pointer;font-size:11px;margin-left:5px}
    .btn-edit{color:#4a90e2;border-color:#4a90e2}
    .btn-edit:hover{background:#4a90e2;color:white}
    .btn-delete{color:#e74c3c;border-color:#e74c3c}
    .btn-delete:hover{background:#e74c3c;color:white}
    .password-prompt{display:inline-block;margin-left:5px}
    .password-input{width:80px;padding:2px 4px;font-size:11px;margin:0 3px}
    .no-comments{text-align:center;color:#999;padding:20px;font-style:italic}
    .comment-instruction{position:absolute;bottom:60px;left:10px;z-index:1000;background:rgba(74,144,226,0.9);color:white;padding:8px 12px;border-radius:5px;font-size:11px;font-family:Arial,sans-serif;display:none;animation:fadeInOut 4s ease-in-out}
    .comment-instruction.show{display:block}
    
    /* Double-click hint */
    .double-click-hint{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1000;background:rgba(74,144,226,0.95);color:white;padding:15px 20px;border-radius:10px;font-family:Arial,sans-serif;display:none;pointer-events:none;box-shadow:0 4px 15px rgba(0,0,0,0.3)}
    .hint-content{display:flex;align-items:center;gap:10px}
    .hint-icon{font-size:24px;animation:bounce 2s infinite}
    .hint-text{font-size:14px;font-weight:500}
    @keyframes bounce{0%,20%,50%,80%,100%{transform:translateY(0)}40%{transform:translateY(-10px)}60%{transform:translateY(-5px)}}
    
    /* Table Detail Popup */
    .table-detail-popup{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);z-index:10000;background:rgba(255,255,255,0.98);backdrop-filter:blur(15px);padding:20px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.3);max-width:500px;width:90%;font-family:Arial,sans-serif;display:none;border:1px solid rgba(255,255,255,0.3)}
    .popup-title{font-size:18px;font-weight:bold;color:#333;margin-bottom:15px;padding-bottom:10px;border-bottom:2px solid #667eea}
    .popup-content{font-size:14px;line-height:1.6;color:#444}
    .popup-close{position:absolute;top:10px;right:15px;background:none;border:none;font-size:24px;cursor:pointer;color:#666;width:30px;height:30px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:all 0.2s}
    .popup-close:hover{background:#f0f0f0;color:#333}
    .popup-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:9999;display:none}

    /* Legend improvements */
    #legend{position:absolute;top:60px;left:10px;z-index:1000;background:rgba(255,255,255,0.95);padding:15px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,0.3);max-width:350px;font-family:Arial,sans-serif;font-size:13px;transition:all 0.3s ease}
    .legend-title{font-weight:bold;font-size:16px;margin-bottom:10px;color:#333;cursor:pointer;user-select:none;display:flex;justify-content:space-between;align-items:center;padding:5px 0}
    .legend-toggle-icon{font-size:12px;color:#666;transition:transform 0.3s ease}
    .legend-collapsed .legend-toggle-icon{transform:rotate(-90deg)}
    .legend-item{display:flex;align-items:center;margin:8px 0;cursor:pointer;padding:8px;border-radius:6px;transition:all 0.2s ease}
    .legend-item:hover{background:#f8f9fa;transform:translateX(3px)}
    .legend-color{width:20px;height:15px;margin-right:10px;border:1px solid #333;border-radius:3px}
    .legend-text{flex:1;line-height:1.3}
    .legend-category{font-weight:bold;color:#444;font-size:12px}
    .legend-subcategory{font-size:11px;color:#666;margin-top:2px}
    .legend-items{transition:max-height 0.3s ease-out,opacity 0.3s ease-out;overflow:hidden}
    .legend-source{margin-top:15px;padding-top:10px;border-top:1px solid #ddd;font-size:11px;color:#666}
    .legend-source a{color:#0066cc;text-decoration:none}
    .legend-source a:hover{text-decoration:underline}

    /* All Comments Panel - Repositioned */
    #all-comments-panel{position:absolute;top:10px;right:10px;z-index:1001;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:0;border-radius:12px;box-shadow:0 8px 25px rgba(0,0,0,0.3);max-width:360px;width:360px;max-height:500px;font-family:Arial,sans-serif;font-size:13px;display:none;overflow:hidden}
    .all-comments-header{background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);padding:15px 20px;margin:0;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid rgba(255,255,255,0.2)}
    .all-comments-title{font-weight:600;font-size:16px;color:white;margin:0;display:flex;align-items:center;gap:8px}
    .all-comments-title:before{content:'💬';font-size:18px}
    /* Top Action Buttons Container */
    .top-actions{position:absolute;top:15px;right:15px;z-index:1002;display:flex;gap:10px;align-items:center}
    
    .toggle-all-comments{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;border:none;padding:10px 16px;border-radius:8px;cursor:pointer;font-size:12px;font-weight:500;box-shadow:0 4px 15px rgba(0,0,0,0.2);transition:all 0.3s ease}
    .toggle-all-comments:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,0.3)}
    
    /* Community Link */
    .community-link{background:linear-gradient(135deg,#ff6b6b 0%,#ee5a52 100%);color:white;text-decoration:none;padding:10px 16px;border-radius:8px;font-size:12px;font-weight:500;box-shadow:0 4px 15px rgba(0,0,0,0.2);transition:all 0.3s ease;display:flex;align-items:center;gap:6px}
    .community-link:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(255,107,107,0.3);color:white}
    .community-icon{font-size:14px}
    .community-text{font-size:12px}
    .all-comments-list{max-height:400px;overflow-y:auto;padding:10px 20px 20px;background:rgba(255,255,255,0.95);color:#333}
    .all-comment-item{background:white;border:none;border-radius:8px;padding:12px;margin-bottom:12px;position:relative;box-shadow:0 2px 8px rgba(0,0,0,0.1);transition:transform 0.2s ease,box-shadow 0.2s ease}
    .all-comment-item:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,0.15)}
    .all-comment-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px}
    .all-comment-region{font-weight:600;color:#667eea;font-size:12px;cursor:pointer;display:flex;align-items:center;gap:4px}
    .all-comment-region:before{content:'📍';font-size:11px}
    .all-comment-region:hover{color:#764ba2;text-decoration:underline}
    .all-comment-meta{text-align:right}
    .all-comment-author{font-size:11px;color:#666;font-weight:500}
    .all-comment-time{font-size:10px;color:#999;margin-top:2px}
    .all-comment-text{font-size:12px;line-height:1.4;color:#444;margin-top:8px;padding:8px;background:#f8f9fa;border-radius:6px;border-left:3px solid #667eea}
    .new-comment-badge{position:absolute;top:-5px;left:8px;background:linear-gradient(135deg,#ff6b6b,#ee5a52);color:white;padding:3px 8px;border-radius:12px;font-size:9px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;animation:pulse 2s infinite;border:2px solid white;box-shadow:0 2px 8px rgba(255,107,107,0.3)}
    @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.05)}100%{transform:scale(1)}}
    .no-all-comments{text-align:center;color:#666;padding:40px 20px;font-style:italic;background:rgba(255,255,255,0.95)}
    .no-all-comments:before{content:'💭';font-size:32px;display:block;margin-bottom:10px;opacity:0.5}
    
    /* Navigation Loading Animation */
    .navigation-loading{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:10002;display:none;justify-content:center;align-items:center;backdrop-filter:blur(5px)}
    .loading-content{text-align:center;color:white;font-family:Arial,sans-serif}
    .loading-spinner{width:60px;height:60px;margin:0 auto 20px;position:relative}
    .loading-spinner div{position:absolute;width:16px;height:16px;border-radius:50%;background:linear-gradient(135deg,#667eea,#764ba2);animation:loadingPulse 1.2s linear infinite}
    .loading-spinner div:nth-child(1){top:8px;left:8px;animation-delay:0s}
    .loading-spinner div:nth-child(2){top:8px;right:8px;animation-delay:-0.4s}
    .loading-spinner div:nth-child(3){bottom:8px;right:8px;animation-delay:-0.8s}
    .loading-spinner div:nth-child(4){bottom:8px;left:8px;animation-delay:-1.2s}
    @keyframes loadingPulse{0%,80%,100%{transform:scale(0)}40%{transform:scale(1)}}
    .loading-text{font-size:16px;font-weight:500;margin-bottom:8px}
    .loading-subtext{font-size:12px;opacity:0.8;color:#ccc}
    .loading-progress{width:200px;height:3px;background:rgba(255,255,255,0.2);border-radius:2px;margin:15px auto 0;overflow:hidden}
    .loading-progress-bar{height:100%;background:linear-gradient(90deg,#667eea,#764ba2);width:0%;animation:progressFill 2s ease-in-out}
    @keyframes progressFill{0%{width:0%}100%{width:100%}}
    
    /* Map highlight animation */
    .region-highlight{animation:highlightRegion 0.8s ease-out}
    @keyframes highlightRegion{0%{opacity:0;transform:scale(0.8)}50%{opacity:1;transform:scale(1.1)}100%{opacity:1;transform:scale(1)}}
    
    /* Mobile Responsive */
    @media (max-width: 768px) {
      #legend{max-width:90%;left:5px;right:5px}
      .legend-title{cursor:pointer;user-select:none;position:relative}
      .legend-title:after{content:'▼';position:absolute;right:0;top:0;transition:transform 0.3s}
      .legend-collapsed .legend-title:after{transform:rotate(-90deg)}
      .legend-items{transition:max-height 0.3s ease-out,opacity 0.3s ease-out;overflow:hidden}
      .legend-collapsed .legend-items{max-height:0!important;opacity:0;margin:0;padding:0}
      .modal-content{width:95%;padding:15px}
      #search-container{left:10px;right:10px;transform:none;width:auto}
      #chat-container{width:250px}
      #all-comments-panel{right:5px;width:95%;max-width:none}
      .top-actions{right:5px;flex-direction:column;gap:5px}
      .double-click-hint{display:none!important}
      .table-detail-popup{width:95%;max-width:none;padding:15px}
    }
  </style>
</head>
<body>
<div id="loading-overlay">
  <div class="spinner"></div>
  <div class="loading-text">Loading map data...</div>
</div>
<div id="search-container">
  <input type="text" id="search-input" placeholder="Search postcode or locality">
  <div id="search-results"></div>
</div>

<div id="legend">
  <div class="legend-title" onclick="toggleLegend()">
    Working Holiday 88-Day Areas
    <span class="legend-toggle-icon">▼</span>
  </div>
  <div class="legend-items">
    <div class="legend-item" onclick="showTableDetail(1)">
      <div class="legend-color" style="background:#ff0000"></div>
      <div class="legend-text">
        <div class="legend-category">Remote/Very Remote Australia (Table 1)</div>
        <div class="legend-subcategory">Tourism and hospitality work</div>
      </div>
    </div>
    <div class="legend-item" onclick="showTableDetail(2)">
      <div class="legend-color" style="background:#ff8c00"></div>
      <div class="legend-text">
        <div class="legend-category">Australia (Table 2)</div>
        <div class="legend-subcategory">Tourism and hospitality work</div>
      </div>
    </div>
    <div class="legend-item" onclick="showTableDetail(3)">
      <div class="legend-color" style="background:#ffff00"></div>
      <div class="legend-text">
        <div class="legend-category">Northern Australia (Table 3)</div>
        <div class="legend-subcategory">Tourism and hospitality work</div>
      </div>
    </div>
    <div class="legend-item" onclick="showTableDetail(4)">
      <div class="legend-color" style="background:#32cd32"></div>
      <div class="legend-text">
        <div class="legend-category">Regional Australia (Table 4)</div>
        <div class="legend-subcategory">Specified work (Primary industries)</div>
      </div>
    </div>
    <div class="legend-item" onclick="showTableDetail(5)">
      <div class="legend-color" style="background:#0078ff"></div>
      <div class="legend-text">
        <div class="legend-category">Bushfire Declared Areas (Table 5)</div>
        <div class="legend-subcategory">Bushfire recovery work</div>
      </div>
    </div>
    <div class="legend-item" onclick="showTableDetail(6)">
      <div class="legend-color" style="background:#9370db"></div>
      <div class="legend-text">
        <div class="legend-category">Natural Disaster Declared Areas (Table 6)</div>
        <div class="legend-subcategory">Natural disaster recovery work</div>
      </div>
    </div>
    
    <div class="legend-source">
      <strong>Source:</strong> Australian Department of Home Affairs<br>
      For detailed information, please refer to:<br>
      <a href="https://immi.homeaffairs.gov.au/what-we-do/whm-program/specified-work-conditions/specified-work-417" target="_blank">
        Official Specified Work Requirements
      </a>
    </div>
  </div>
</div>

<div class="popup-overlay" id="popup-overlay" onclick="closeTableDetail()"></div>
<div class="table-detail-popup" id="table-detail-popup">
  <button class="popup-close" onclick="closeTableDetail()">&times;</button>
  <div class="popup-title" id="popup-title"></div>
  <div class="popup-content" id="popup-content"></div>
</div>

<div id="info-panel">
  <span class="close-btn" onclick="hideInfo()">&times;</span>
  <div class="info-title" id="info-title"></div>
  <div class="info-content" id="info-content"></div>
</div>

<div class="top-actions">
  <a href="community/" class="community-link" title="Join 88 Zones Community">
    <span class="community-icon">👥</span>
    <span class="community-text">Community</span>
  </a>
  <button class="toggle-all-comments" onclick="toggleAllComments()">💬 All Comments</button>
</div>

<div id="all-comments-panel">
  <div class="all-comments-header">
    <h3 class="all-comments-title">All Comments</h3>
    <span class="close-btn" onclick="toggleAllComments()">&times;</span>
  </div>
  <div class="all-comments-list" id="all-comments-list">
    <div class="no-all-comments">No comments yet.</div>
  </div>
</div>

<div id="visitor-stats">
  <div class="stat-line">Total Visitors: <span id="total-visitors">0</span></div>
  <div class="stat-line">Today's Visitors: <span id="today-visitors">0</span></div>
</div>

<div id="creator-info">
  <div class="creator-line">📍 Created by <strong>하고싶은게많은🇰🇷</strong></div>
  <div class="creator-line">📧 <a href="#" onclick="copyEmail(event)">Contact</a> | 📺 <a href="https://www.youtube.com/@%ED%95%98%EA%B3%A0%EC%8B%B6%EC%9D%80%EA%B2%8C%EB%A7%8E%EC%9D%80" target="_blank">YouTube</a></div>
</div>

<div id="comment-instruction" class="comment-instruction">
  💬 Double-click any region to leave comments!
</div>

<div id="double-click-hint" class="double-click-hint">
  <div class="hint-content">
    <span class="hint-icon">👆</span>
    <span class="hint-text">Double-click regions to comment</span>
  </div>
</div>

<div id="navigation-loading" class="navigation-loading">
  <div class="loading-content">
    <div class="loading-spinner">
      <div></div>
      <div></div>
      <div></div>
      <div></div>
    </div>
    <div class="loading-text">Navigating to region...</div>
    <div class="loading-subtext" id="loading-region-name">Please wait</div>
    <div class="loading-progress">
      <div class="loading-progress-bar"></div>
    </div>
  </div>
</div>

<div id="chat-container" class="chat-collapsed">
  <div id="chat-header" onclick="toggleChat()">💬 Guestbook <span id="chat-status">🔄</span></div>
  <div id="chat-content">
    <div id="chat-messages"></div>
    <div id="chat-input-container">
      <div class="input-row">
        <input type="text" id="username-input" placeholder="Name" maxlength="20">
        <input type="text" id="chat-input" placeholder="Leave a message..." maxlength="200">
      </div>
      <button id="chat-send" onclick="sendMessage()" style="width:100%;margin-top:2px;">Send</button>
    </div>
  </div>
</div>

<div id="comment-modal">
  <div class="modal-content">
    <button class="close-modal" onclick="closeCommentModal()">&times;</button>
    <div class="modal-header">
      <h2 class="modal-title" id="comment-modal-title">Comments for </h2>
    </div>
    
    <div class="comment-form">
      <div class="form-group">
        <label for="comment-name">Name:</label>
        <input type="text" id="comment-name" maxlength="30" placeholder="Enter your name">
      </div>
      <div class="form-group">
        <label for="comment-password">Password:</label>
        <input type="password" id="comment-password" maxlength="50" placeholder="Password for edit/delete">
      </div>
      <div class="form-group">
        <label for="comment-text">Comment:</label>
        <textarea id="comment-text" maxlength="500" placeholder="Write your comment about this region..."></textarea>
      </div>
      <button class="btn-primary" onclick="submitComment()">Post Comment</button>
    </div>
    
    <div class="comments-list" id="comments-list">
      <div class="no-comments">No comments yet. Be the first to comment!</div>
    </div>
  </div>
</div>

<div id="map"></div>

<!-- SEO Content (Hidden but readable by search engines) -->
<div style="position:absolute;left:-9999px;top:-9999px;">
  <h1>88 Days Map Australia - Working Holiday Visa Regional Work Areas</h1>
  <h2>Complete Guide to Australian Working Holiday Visa 88-Day Requirement</h2>
  
  <section>
    <h3>What is the 88-Day Requirement?</h3>
    <p>Australian Working Holiday visa (subclass 417) holders must complete 88 days of specified work in regional Australia to be eligible for a second Working Holiday visa. Our interactive map shows all eligible postcodes and work areas across Australia.</p>
  </section>
  
  <section>
    <h3>Eligible Work Areas by Category</h3>
    <h4>Remote and Very Remote Australia (Tables 1-3)</h4>
    <p>Tourism and hospitality work in remote areas including restaurants, cafes, hotels, and accommodation services. Work must be completed from 22 June 2021 onwards.</p>
    
    <h4>Regional Australia (Table 4)</h4>
    <p>Primary industry work including agriculture, mining, forestry, construction, and fishing in designated regional areas across Australia.</p>
    
    <h4>Bushfire Recovery Areas (Table 5)</h4>
    <p>Bushfire recovery and cleanup work in declared bushfire affected areas. Work must be completed after 31 July 2019.</p>
    
    <h4>Natural Disaster Areas (Table 6)</h4>
    <p>Recovery work in areas affected by floods, cyclones, and severe weather events. Applies to work completed from 31 December 2021.</p>
  </section>
  
  <section>
    <h3>How to Use This Map</h3>
    <p>Search for your postcode or locality using the search function. Click on colored areas to view detailed work requirements. Join our real-time chat to connect with other Working Holiday visa holders.</p>
  </section>
  
  <section>
    <h3>Key Features</h3>
    <ul>
      <li>Interactive postcode map with 2000+ eligible areas</li>
      <li>Real-time search for postcodes and localities</li>
      <li>Detailed work requirement information for each area type</li>
      <li>Official government source references</li>
      <li>Real-time chat community for visa holders</li>
      <li>Mobile-friendly responsive design</li>
    </ul>
  </section>
  
  <section>
    <h3>Official Information Source</h3>
    <p>All information is sourced from the Australian Department of Home Affairs official specified work requirements for Working Holiday visa subclass 417.</p>
  </section>
  
  <!-- Korean SEO Content -->
  <section lang="ko">
    <h2>호주워홀 세컨비자 지도 - 호주 워킹홀리데이 88일 지역근무</h2>
    <h3>호주워홀 세컨비자란?</h3>
    <p>호주 워킹홀리데이 비자(서브클래스 417) 소지자는 세컨비자(두 번째 워킹홀리데이 비자)를 신청하기 위해 호주 지역 지역에서 88일의 특정 작업을 완료해야 합니다. 우리의 세컨지도는 호주 전역의 모든 해당 우편번호와 작업 지역을 보여줍니다.</p>
  </section>
  
  <section lang="ko">
    <h3>세컨비자 지도 사용법</h3>
    <p>우편번호나 지역명으로 검색하여 세컨비자 조건에 맞는 일자리를 찾아보세요. 색상별 지역을 클릭하면 자세한 작업 요구사항을 확인할 수 있습니다. 실시간 채팅으로 다른 워홀러들과 정보를 공유해보세요.</p>
  </section>
  
  <section lang="ko">
    <h3>호주워홀 88일 작업 종류</h3>
    <h4>농업 및 1차 산업 (지역 호주)</h4>
    <p>농장 일자리, 목축업, 어업, 임업, 광업 등 호주 지역 지역에서의 1차 산업 작업으로 세컨비자 조건을 충족할 수 있습니다.</p>
    
    <h4>관광 및 접객업 (원격 지역)</h4>
    <p>호텔, 카페, 레스토랑, 숙박업소 등 원격 지역에서의 관광 및 접객업 일자리도 2021년 6월 22일부터 세컨비자 조건으로 인정됩니다.</p>
    
    <h4>자연재해 복구 작업</h4>
    <p>산불, 홍수, 사이클론 피해 지역의 복구 작업도 세컨비자 조건에 해당합니다.</p>
  </section>
  
  <section lang="ko">
    <h3>세컨비자 지도 주요 기능</h3>
    <ul>
      <li>2000개 이상의 해당 우편번호가 포함된 인터랙티브 지도</li>
      <li>우편번호 및 지역명 실시간 검색</li>
      <li>각 지역 유형별 상세한 작업 요구사항 정보</li>
      <li>정부 공식 출처 참조</li>
      <li>워홀러를 위한 실시간 채팅 커뮤니티</li>
      <li>모바일 친화적 반응형 디자인</li>
    </ul>
  </section>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* 1. 지도 */
const map = L.map('map').setView([-27, 133], 5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution:'© OpenStreetMap contributors'
}).addTo(map);

/* 2. POA 폴리곤 불러오기 */
let localityTable = {}; // postcode → locality
let geoLayer; // 검색을 위해 저장
let highlightedLayer = null; // 현재 강조된 레이어
let table1Postcodes = new Set(); // table 1 (빨간색)
let table2Postcodes = new Set(); // table 2 (주황색)
let table3Postcodes = new Set(); // table 3 (노란색)
let table4Postcodes = new Set(); // table 4 (초록색)
let table5Postcodes = new Set(); // table 5 (파란색)
let table6Postcodes = new Set(); // table 6 (보라색)

// CSV 파일들에서 우편번호 파싱
function parsePostcodes(postcodeStr) {
  const postcodes = [];
  const parts = postcodeStr.split(',').map(s => s.trim());
  
  for (let part of parts) {
    if (part.includes(' to ')) {
      const [start, end] = part.split(' to ').map(s => parseInt(s.trim()));
      for (let i = start; i <= end; i++) {
        postcodes.push(i.toString());
      }
    } else {
      postcodes.push(part);
    }
  }
  return postcodes;
}

// 전체 주/테리토리 우편번호 추가 함수
function addAllPostcodes(state, targetSet) {
  if (state.includes('Northern Territory') || state.includes('ACT')) {
    for (let i = 800; i <= 999; i++) {
      targetSet.add('0' + i);
    }
    for (let i = 200; i <= 299; i++) {
      targetSet.add('0' + i);
    }
  } else if (state.includes('South Australia')) {
    for (let i = 5000; i <= 5999; i++) {
      targetSet.add(i.toString());
    }
  } else if (state.includes('Tasmania')) {
    for (let i = 7000; i <= 7999; i++) {
      targetSet.add(i.toString());
    }
  } else if (state.includes('Norfolk Island')) {
    targetSet.add('2899');
  }
}

Promise.all([
  fetch('postcode2name.json').then(r => r.json()),
  Promise.all([
    "data/geo_chunk_0.json", "data/geo_chunk_1.json", "data/geo_chunk_2.json", "data/geo_chunk_3.json", 
    "data/geo_chunk_4.json", "data/geo_chunk_5.json", "data/geo_chunk_6.json", "data/geo_chunk_7.json",
    "data/geo_chunk_8.json", "data/geo_chunk_9.json", "data/geo_chunk_10.json", "data/geo_chunk_11.json",
    "data/geo_chunk_12.json", "data/geo_chunk_13.json", "data/geo_chunk_14.json", "data/geo_chunk_15.json",
    "data/geo_chunk_16.json", "data/geo_chunk_17.json", "data/geo_chunk_18.json", "data/geo_chunk_19.json",
    "data/geo_chunk_20.json", "data/geo_chunk_21.json", "data/geo_chunk_22.json", "data/geo_chunk_23.json",
    "data/geo_chunk_24.json", "data/geo_chunk_25.json", "data/geo_chunk_26.json"
  ].map(file => fetch(file).then(r => r.json()))
  ).then(chunks => {
    const allFeatures = [];
    chunks.forEach(chunk => allFeatures.push(...chunk.features));
    return { type: 'FeatureCollection', features: allFeatures };
  }),
  fetch('data/table1.csv').then(r => r.text()),
  fetch('data/table2.csv').then(r => r.text()),
  fetch('data/table3.csv').then(r => r.text()),
  fetch('data/table4.csv').then(r => r.text()),
  fetch('data/table5.csv').then(r => r.text()),
  fetch('data/table6.csv').then(r => r.text())
])
.then(([nameMap, geo, table1, table2, table3, table4, table5, table6]) => {
  localityTable = nameMap;
  
  // 각 테이블에서 우편번호 추출
  const tableSets = [table1Postcodes, table2Postcodes, table3Postcodes, table4Postcodes, table5Postcodes, table6Postcodes];
  const csvFiles = [table1, table2, table3, table4, table5, table6];
  
  csvFiles.forEach((csvText, tableIndex) => {
    const lines = csvText.split('\n').slice(1);
    lines.forEach(line => {
      if (line.trim()) {
        const firstCommaIndex = line.indexOf(',');
        if (firstCommaIndex > 0) {
          const state = line.substring(0, firstCommaIndex).trim();
          const postcodes = line.substring(firstCommaIndex + 1).trim().replace(/"/g, '');
          
          if (postcodes && !postcodes.includes('All') && postcodes !== 'All areas.') {
            const codes = postcodes.split(',').map(s => s.trim()).filter(s => s);
            codes.forEach(code => tableSets[tableIndex].add(code));
          } else if (postcodes && (postcodes.includes('All') || postcodes === 'All areas.')) {
            addAllPostcodes(state, tableSets[tableIndex]);
          }
        }
      }
    });
  });
  
  // 색상 정의
  const tableColors = ['#ff0000', '#ff8c00', '#ffff00', '#32cd32', '#0078ff', '#9370db']; // 빨강, 주황, 노랑, 라임그린, 파랑, 보라
  
  geoLayer = L.geoJSON(geo, {
    style: (feature) => {
      const pcode = feature.properties.POA_CODE_2021;
      
      // 각 테이블 순서대로 확인
      for (let i = 0; i < tableSets.length; i++) {
        if (tableSets[i].has(pcode)) {
          return { color: tableColors[i], weight: 1, fillOpacity: 0.5 };
        }
      }
      
      // 어떤 테이블에도 없으면 기본 파란색
      return { color: '#87ceeb', weight: 1, fillOpacity: 0.3 };
    },
    onEachFeature: (feature, layer) => {
      const pcode = feature.properties.POA_CODE_2021;
      const name  = localityTable[pcode] || 'Unknown';
      layer.bindTooltip(`${name}, ${pcode}`, { sticky: true });
      layer.pcode = pcode;
      layer.name = name;
      
      // 원래 스타일 저장
      let originalColor = '#87ceeb';
      for (let i = 0; i < tableSets.length; i++) {
        if (tableSets[i].has(pcode)) {
          originalColor = tableColors[i];
          break;
        }
      }
      layer.originalStyle = { color: originalColor, weight: 1, fillOpacity: 0.5 };
      
      // 폴리곤 클릭 이벤트 추가 - 더블클릭시 댓글 모달 열기
      layer.on('click', function(e) {
        highlightLayer(layer);
        showDoubleClickHint(); // 힌트 표시
        L.DomEvent.stopPropagation(e);
      });
      
      layer.on('dblclick', function(e) {
        openCommentModal(pcode, name);
        L.DomEvent.stopPropagation(e);
      });
    }
  }).addTo(map);
  
  setupSearch();
  initVisitorStats();
  
  // 로딩 완료 후 오버레이 숨기기
  document.getElementById('loading-overlay').style.display = 'none';
  
  // 채팅 초기화
  initChat();
  
  // 댓글 안내 메시지 표시
  showCommentInstruction();
})
.catch(err => {
  console.error('전체 로딩 실패:', err);
  alert('로딩 실패: ' + err.message);
});

/* 5. Firebase 방문자 통계 기능 */
function initVisitorStats() {
  // Firebase 로딩 대기
  setTimeout(() => {
    if (window.firebaseDB) {
      setupFirebaseVisitorStats();
    } else {
      // Firebase 실패시 로컬 스토리지 사용
      setupLocalVisitorStats();
    }
  }, 1500); // 채팅보다 조금 늦게 로딩
}

function setupFirebaseVisitorStats() {
  const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD 형태
  const visitorId = getOrCreateVisitorId();
  
  // Firebase에서 통계 데이터 실시간 조회
  const statsRef = window.firebaseRef(window.firebaseDB, 'statistics');
  window.firebaseOnValue(statsRef, (snapshot) => {
    const data = snapshot.val() || {};
    displayVisitorStats(data);
  });
  
  // 방문 기록
  recordVisit(today, visitorId);
}

function getOrCreateVisitorId() {
  let visitorId = localStorage.getItem('visitorId');
  if (!visitorId) {
    visitorId = 'visitor_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    localStorage.setItem('visitorId', visitorId);
  }
  return visitorId;
}

async function recordVisit(today, visitorId) {
  const lastVisit = localStorage.getItem('lastFirebaseVisit');
  const shouldRecord = lastVisit !== today;
  
  if (shouldRecord) {
    try {
      // 오늘 방문자로 기록 (중복 방지)
      const todayVisitorRef = window.firebaseRef(window.firebaseDB, `statistics/dailyVisitors/${today}/${visitorId}`);
      await window.firebaseSet(todayVisitorRef, {
        timestamp: window.firebaseServerTimestamp(),
        date: today
      });
      
      // 총 방문자 수 트랜잭션으로 안전하게 증가
      const totalRef = window.firebaseRef(window.firebaseDB, 'statistics/totalVisitors');
      await window.firebaseRunTransaction(totalRef, (currentValue) => {
        return (currentValue || 0) + 1;
      });
      
      localStorage.setItem('lastFirebaseVisit', today);
      console.log('✅ Visit recorded to Firebase');
      
    } catch (error) {
      console.error('❌ Failed to record visit:', error);
      // Firebase 실패시 로컬 스토리지로 폴백
      setupLocalVisitorStats();
    }
  }
}

function displayVisitorStats(data) {
  const today = new Date().toISOString().split('T')[0];
  const totalVisitors = data.totalVisitors || 0;
  const todayVisitors = data.dailyVisitors && data.dailyVisitors[today] ? 
    Object.keys(data.dailyVisitors[today]).length : 0;
  
  document.getElementById('total-visitors').textContent = totalVisitors.toLocaleString();
  document.getElementById('today-visitors').textContent = todayVisitors.toLocaleString();
}

function setupLocalVisitorStats() {
  const today = new Date().toDateString();
  
  // 로컬 스토리지에서 방문자 데이터 가져오기
  let totalVisitors = parseInt(localStorage.getItem('totalVisitors') || '0');
  let todayVisitors = parseInt(localStorage.getItem('todayVisitors') || '0');
  let lastVisitDate = localStorage.getItem('lastVisitDate') || '';
  
  // 오늘 첫 방문인지 확인
  if (lastVisitDate !== today) {
    todayVisitors = 0;
    localStorage.setItem('lastVisitDate', today);
  }
  
  // 방문자 수 증가
  totalVisitors += 1;
  todayVisitors += 1;
  
  // 로컬 스토리지에 저장
  localStorage.setItem('totalVisitors', totalVisitors.toString());
  localStorage.setItem('todayVisitors', todayVisitors.toString());
  
  // 화면에 표시
  document.getElementById('total-visitors').textContent = totalVisitors.toLocaleString();
  document.getElementById('today-visitors').textContent = todayVisitors.toLocaleString();
}

/* 6. 정보 패널 기능 */
function showInfo(tableNum) {
  const infoData = {
    1: {
      title: "Remote and Very Remote Australia (Table 1)",
      content: `<strong>Work Requirements:</strong><br>
        Tourism and hospitality work carried out from 22 June 2021 in the following areas of Remote and Very Remote Australia is considered eligible specified work for the purpose of a second or third Working Holiday (subclass 417) visa application lodged from 5 March 2022.`
    },
    2: {
      title: "Australia (Table 2)",
      content: `<strong>Work Requirements:</strong><br>
        Tourism and hospitality work carried out from 22 June 2021 in the following areas of Australia is considered eligible specified work for the purpose of a second or third Working Holiday (subclass 417) visa application lodged from 1 July 2022.`
    },
    3: {
      title: "Northern Australia (Table 3)",
      content: `<strong>Work Requirements:</strong><br>
        Tourism and hospitality work carried out from 22 June 2021 in the following areas of Northern Australia is considered eligible specified work for the purpose of a second or third Working Holiday (subclass 417) visa application lodged from 5 March 2022.`
    },
    4: {
      title: "Regional Australia (Table 4)",
      content: `<strong>Work Requirements:</strong><br>
        Specified work carried out in the following areas of regional Australia is considered eligible specified work for the purpose of a second or third Working Holiday (subclass 417) visa.`
    },
    5: {
      title: "Bushfire Declared Areas (Table 5)",
      content: `<strong>Work Requirements:</strong><br>
        Bushfire recovery work carried out after 31 July 2019 in the following areas is considered specified work for the purpose of a second or third Working Holiday (subclass 417) visa.`
    },
    6: {
      title: "Natural Disaster Declared Areas (Table 6)",
      content: `<strong>Work Requirements:</strong><br>
        Recovery work carried out from 31 December 2021 in the following areas of Australia, that have been declared affected by other natural disasters, such as flood, cyclones or other severe weather events, is considered eligible for specified work for the purpose of a second or third Working Holiday (subclass 417) visa.<br><br>
        <strong>Application Requirements:</strong><br>
        This applies to applications lodged on or after 5 April 2025 and undecided applications on this date.`
    }
  };

  const info = infoData[tableNum];
  document.getElementById('info-title').textContent = info.title;
  document.getElementById('info-content').innerHTML = info.content;
  document.getElementById('info-panel').style.display = 'block';
}

function hideInfo() {
  document.getElementById('info-panel').style.display = 'none';
}

/* 3. 검색 기능 */
function setupSearch() {
  const searchInput = document.getElementById('search-input');
  const searchResults = document.getElementById('search-results');
  
  searchInput.addEventListener('input', function() {
    const query = this.value.trim();
    if (query.length < 2) {
      searchResults.style.display = 'none';
      return;
    }
    
    const results = [];
    geoLayer.eachLayer(layer => {
      const pcode = layer.pcode;
      const name = layer.name;
      if (pcode.includes(query) || name.toLowerCase().includes(query.toLowerCase())) {
        results.push({ pcode, name, layer });
      }
    });
    
    if (results.length > 0) {
      searchResults.innerHTML = results.slice(0, 10).map(result => 
        `<div class="search-result" data-pcode="${result.pcode}">${result.name}, ${result.pcode}</div>`
      ).join('');
      searchResults.style.display = 'block';
    } else {
      searchResults.style.display = 'none';
    }
  });
  
  searchResults.addEventListener('click', function(e) {
    if (e.target.classList.contains('search-result')) {
      const pcode = e.target.dataset.pcode;
      geoLayer.eachLayer(layer => {
        if (layer.pcode === pcode) {
          highlightLayer(layer);
          map.fitBounds(layer.getBounds());
          layer.openTooltip();
        }
      });
      searchResults.style.display = 'none';
      searchInput.value = '';
    }
  });
  
  document.addEventListener('click', function(e) {
    if (!e.target.closest('#search-container')) {
      searchResults.style.display = 'none';
    }
  });
}

/* 4. 레이어 강조 기능 */
function highlightLayer(layer) {
  // 이전 강조 해제
  if (highlightedLayer) {
    highlightedLayer.setStyle(highlightedLayer.originalStyle);
  }
  
  // 원래 색상을 더 진하게 만들어 강조
  const originalColor = layer.originalStyle.color;
  const darkerColor = getDarkerColor(originalColor);
  
  layer.setStyle({
    color: darkerColor,
    weight: 3,
    fillOpacity: 0.8
  });
  
  highlightedLayer = layer;
}

// 색상을 더 진하게 만드는 함수
function getDarkerColor(hexColor) {
  const colorMap = {
    '#ff0000': '#cc0000', // 빨간색 -> 더 진한 빨간색
    '#ff8c00': '#e6660a', // 주황색 -> 더 진한 주황색
    '#ffff00': '#cccc00', // 노란색 -> 더 진한 노란색
    '#32cd32': '#228b22', // 라임그린 -> 더 진한 초록색
    '#0078ff': '#0056cc', // 파란색 -> 더 진한 파란색
    '#9370db': '#7b68ee', // 보라색 -> 더 진한 보라색
    '#87ceeb': '#5f9ea0'  // 연한 파란색 -> 더 진한 파란색
  };
  
  return colorMap[hexColor] || hexColor;
}

// 지도 클릭시 강조 해제
map.on('click', function(e) {
  if (highlightedLayer) {
    highlightedLayer.setStyle(highlightedLayer.originalStyle);
    highlightedLayer = null;
  }
});

/* 7. Firebase 실시간 채팅 기능 */
function initChat() {
  // Firebase 로딩 대기 후 채팅 설정
  setTimeout(() => {
    if (window.chatBackend && window.chatBackend.enabled && window.firebaseDB) {
      setupFirebaseChat();
      showChatStatus('🔥 Real-time chat connected!');
    } else {
      loadMessages();
      showChatStatus('💬 Local chat only - Firebase connection failed');
    }
  }, 1000); // Firebase 로딩 대기
  
  // Enter 키로 메시지 전송
  document.getElementById('chat-input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      sendMessage();
    }
  });
  
  document.getElementById('username-input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      document.getElementById('chat-input').focus();
    }
  });
  
  // 저장된 사용자명 불러오기
  const savedUsername = localStorage.getItem('guestbookUsername');
  if (savedUsername) {
    document.getElementById('username-input').value = savedUsername;
  }
}

function setupFirebaseChat() {
  // Firebase 실시간 메시지 리스너 설정
  const messagesRef = window.firebaseRef(window.firebaseDB, 'messages');
  const messagesQuery = window.firebaseQuery(messagesRef, window.firebaseLimitToLast(50));
  
  window.firebaseOnValue(messagesQuery, (snapshot) => {
    const data = snapshot.val();
    displayFirebaseMessages(data);
  }, (error) => {
    console.error('Firebase error:', error);
    showChatStatus('❌ Real-time chat error - using local storage');
    loadMessages();
  });
}

function showChatStatus(message) {
  const header = document.getElementById('chat-header');
  const statusSpan = document.getElementById('chat-status');
  
  header.title = message;
  
  // 상태 아이콘 업데이트
  if (message.includes('Real-time chat connected')) {
    statusSpan.textContent = '🔥';
    statusSpan.title = 'Real-time chat active';
  } else if (message.includes('Local chat only')) {
    statusSpan.textContent = '💾';
    statusSpan.title = 'Local storage only';
  } else if (message.includes('error') || message.includes('Failed')) {
    statusSpan.textContent = '❌';
    statusSpan.title = 'Connection error';
  } else {
    statusSpan.textContent = '🔄';
    statusSpan.title = 'Connecting...';
  }
  
  // 5초 후 툴팁 제거
  setTimeout(() => {
    header.title = '';
  }, 5000);
}

function toggleChat() {
  const content = document.getElementById('chat-content');
  const container = document.getElementById('chat-container');
  
  if (content.style.display === 'none' || content.style.display === '') {
    content.style.display = 'block';
    container.classList.remove('chat-collapsed');
  } else {
    content.style.display = 'none';
    container.classList.add('chat-collapsed');
  }
}

function sendMessage() {
  const input = document.getElementById('chat-input');
  const usernameInput = document.getElementById('username-input');
  const message = input.value.trim();
  const username = usernameInput.value.trim() || 'Anonymous';
  
  if (message) {
    // 사용자명을 로컬 스토리지에 저장 (다음에 자동 입력)
    localStorage.setItem('guestbookUsername', username);
    
    if (window.chatBackend && window.chatBackend.enabled && window.firebaseDB) {
      // Firebase에 메시지 전송
      const messagesRef = window.firebaseRef(window.firebaseDB, 'messages');
      const messageData = {
        text: message,
        author: username,
        timestamp: window.firebaseServerTimestamp()
      };
      
      window.firebasePush(messagesRef, messageData).then(() => {
        console.log('✅ Message sent to Firebase');
      }).catch((error) => {
        console.error('❌ Firebase send error:', error);
        // Firebase 실패시 로컬 저장으로 폴백
        saveToLocalStorage(message, username);
        showChatStatus('❌ Failed to send - saved locally');
      });
    } else {
      // Firebase 없으면 로컬 저장
      saveToLocalStorage(message, username);
    }
    
    // 메시지 입력창만 비우기 (사용자명은 유지)
    input.value = '';
  }
}

function saveToLocalStorage(message, username) {
  const timestamp = new Date().toLocaleString();
  const messageObj = {
    text: message,
    author: username,
    time: timestamp
  };
  
  const messages = getMessages();
  messages.push(messageObj);
  
  // 최대 50개 메시지만 유지
  if (messages.length > 50) {
    messages.splice(0, messages.length - 50);
  }
  
  localStorage.setItem('guestbookMessages', JSON.stringify(messages));
  addMessageToChat(messageObj);
  
  const messagesContainer = document.getElementById('chat-messages');
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function getMessages() {
  const stored = localStorage.getItem('guestbookMessages');
  return stored ? JSON.parse(stored) : [];
}

function loadMessages() {
  const messages = getMessages();
  const container = document.getElementById('chat-messages');
  
  container.innerHTML = '';
  
  if (messages.length === 0) {
    container.innerHTML = '<div style="color:#999;text-align:center;padding:20px;">No messages yet. Be the first to leave a message!</div>';
  } else {
    messages.forEach(msg => addMessageToChat(msg));
    container.scrollTop = container.scrollHeight;
  }
}

function displayFirebaseMessages(data) {
  const container = document.getElementById('chat-messages');
  container.innerHTML = '';
  
  if (!data) {
    container.innerHTML = '<div style="color:#999;text-align:center;padding:20px;">🔥 Real-time chat enabled! Be the first to leave a message!</div>';
    return;
  }
  
  // Firebase 메시지를 배열로 변환하고 시간순 정렬
  const messages = Object.entries(data).map(([key, value]) => ({
    ...value,
    id: key
  })).sort((a, b) => {
    // timestamp가 있으면 사용, 없으면 현재 시간
    const timeA = a.timestamp || Date.now();
    const timeB = b.timestamp || Date.now();
    return timeA - timeB;
  });
  
  // 최근 50개만 표시
  const recentMessages = messages.slice(-50);
  
  recentMessages.forEach(msg => {
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message';
    
    const displayTime = msg.timestamp ? 
      new Date(msg.timestamp).toLocaleString() : 
      (msg.time || 'Just now');
    
    messageDiv.innerHTML = `
      <div class="message-header">
        <div class="message-author">${escapeHtml(msg.author || 'Anonymous')}</div>
        <div class="message-time">${displayTime}</div>
      </div>
      <div class="message-text">${escapeHtml(msg.text || '')}</div>
    `;
    
    container.appendChild(messageDiv);
  });
  
  container.scrollTop = container.scrollHeight;
}

function addMessageToChat(messageObj) {
  const container = document.getElementById('chat-messages');
  const messageDiv = document.createElement('div');
  messageDiv.className = 'message';
  
  // 첫 번째 메시지인 경우 환영 메시지 제거
  if (container.querySelector('[style*="color:#999"]')) {
    container.innerHTML = '';
  }
  
  messageDiv.innerHTML = `
    <div class="message-header">
      <div class="message-author">${escapeHtml(messageObj.author || 'Anonymous')}</div>
      <div class="message-time">${messageObj.time}</div>
    </div>
    <div class="message-text">${escapeHtml(messageObj.text)}</div>
  `;
  
  container.appendChild(messageDiv);
}

// HTML 이스케이프 함수
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

/* 8. 이메일 복사 기능 */
function copyEmail(event) {
  event.preventDefault();
  const email = 'somanytube@gmail.com';
  
  // 클립보드에 복사
  navigator.clipboard.writeText(email).then(function() {
    // 복사 성공 메시지 표시
    showCopyMessage('📧 Email copied to clipboard!');
  }).catch(function() {
    // 대체 방법 (구련 브라우저)
    const textArea = document.createElement('textarea');
    textArea.value = email;
    document.body.appendChild(textArea);
    textArea.select();
    document.execCommand('copy');
    document.body.removeChild(textArea);
    showCopyMessage('📧 Email copied to clipboard!');
  });
}

function showCopyMessage(message) {
  showSuccessMessage(message);
}

function showSuccessMessage(message, type = 'success') {
  // 기존 메시지가 있으면 제거
  const existingMsg = document.getElementById('success-message');
  if (existingMsg) {
    existingMsg.remove();
  }
  
  // 메시지 타입별 색상 설정
  const colors = {
    success: 'linear-gradient(135deg, #4CAF50, #45a049)',
    edit: 'linear-gradient(135deg, #FF9800, #F57C00)',
    delete: 'linear-gradient(135deg, #f44336, #d32f2f)',
    info: 'linear-gradient(135deg, #2196F3, #1976D2)'
  };
  
  // 메시지 타입별 아이콘
  const icons = {
    success: '✅',
    edit: '✏️', 
    delete: '🗑️',
    info: 'ℹ️'
  };
  
  // 메시지 엘리먼트 생성
  const messageDiv = document.createElement('div');
  messageDiv.id = 'success-message';
  messageDiv.innerHTML = `<span class="message-icon">${icons[type]}</span><span class="message-text">${message}</span>`;
  messageDiv.style.cssText = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: ${colors[type]};
    color: white;
    padding: 15px 25px;
    border-radius: 10px;
    font-size: 14px;
    font-family: Arial, sans-serif;
    font-weight: 500;
    z-index: 10001;
    box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    animation: successFadeInOut 3s ease-in-out;
    display: flex;
    align-items: center;
    gap: 8px;
    min-width: 200px;
    text-align: center;
  `;
  
  // CSS 애니메이션 추가
  if (!document.getElementById('success-animation-style')) {
    const style = document.createElement('style');
    style.id = 'success-animation-style';
    style.textContent = `
      @keyframes successFadeInOut {
        0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
        15% { opacity: 1; transform: translate(-50%, -50%) scale(1.05); }
        20% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        85% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
      }
      .message-icon { font-size: 16px; }
      .message-text { flex: 1; }
    `;
    document.head.appendChild(style);
  }
  
  document.body.appendChild(messageDiv);
  
  // 3초 후 자동 제거
  setTimeout(() => {
    if (messageDiv.parentNode) {
      messageDiv.remove();
    }
  }, 3000);
}

/* 9. 범례 기능 개선 */
function toggleLegend() {
  const legend = document.getElementById('legend');
  const legendItems = document.querySelector('.legend-items');
  const toggleIcon = document.querySelector('.legend-toggle-icon');
  
  legend.classList.toggle('legend-collapsed');
  
  if (legend.classList.contains('legend-collapsed')) {
    legendItems.style.maxHeight = '0px';
    legendItems.style.opacity = '0';
    toggleIcon.textContent = '▶';
  } else {
    legendItems.style.maxHeight = legendItems.scrollHeight + 'px';
    legendItems.style.opacity = '1';
    toggleIcon.textContent = '▼';
  }
}

// 테이블 상세 정보 팝업 표시
function showTableDetail(tableNum) {
  const popup = document.getElementById('table-detail-popup');
  const overlay = document.getElementById('popup-overlay');
  const title = document.getElementById('popup-title');
  const content = document.getElementById('popup-content');
  
  const tableData = {
    1: {
      title: "Remote and Very Remote Australia (Table 1)",
      content: `<strong>Work Requirements:</strong><br><br>
        Tourism and hospitality work carried out from <strong>22 June 2021</strong> in the following areas of Remote and Very Remote Australia is considered eligible specified work for the purpose of a second or third Working Holiday (subclass 417) visa application lodged from <strong>5 March 2022</strong>.<br><br>
        
        <strong>Eligible Work Types:</strong><br>
        • Restaurant and café work<br>
        • Hotel and accommodation services<br>
        • Tour guide services<br>
        • Event management and catering<br>
        • Retail services in tourism areas<br><br>
        
        <strong>Important Notes:</strong><br>
        • Work must be in designated remote/very remote areas<br>
        • Minimum 88 days of work required<br>
        • Work must be with eligible employers`
    },
    2: {
      title: "Australia (Table 2)",
      content: `<strong>Work Requirements:</strong><br><br>
        Tourism and hospitality work carried out from <strong>22 June 2021</strong> in the following areas of Australia is considered eligible specified work for the purpose of a second or third Working Holiday (subclass 417) visa application lodged from <strong>1 July 2022</strong>.<br><br>
        
        <strong>Eligible Work Types:</strong><br>
        • Tourism-related accommodation services<br>
        • Food service in tourism areas<br>
        • Tour operations and activities<br>
        • Conference and event services<br>
        • Travel and booking services<br><br>
        
        <strong>Coverage:</strong><br>
        Broader coverage than Table 1, including additional tourism-focused regions across Australia.`
    },
    3: {
      title: "Northern Australia (Table 3)",
      content: `<strong>Work Requirements:</strong><br><br>
        Tourism and hospitality work carried out from <strong>22 June 2021</strong> in the following areas of Northern Australia is considered eligible specified work for the purpose of a second or third Working Holiday (subclass 417) visa application lodged from <strong>5 March 2022</strong>.<br><br>
        
        <strong>Focus Areas:</strong><br>
        • Northern Territory regions<br>
        • Northern Queensland areas<br>
        • Northern Western Australia<br><br>
        
        <strong>Special Considerations:</strong><br>
        • Seasonal work opportunities<br>
        • Remote location benefits<br>
        • Cultural and eco-tourism focus`
    },
    4: {
      title: "Regional Australia (Table 4)",
      content: `<strong>Work Requirements:</strong><br><br>
        Specified work carried out in the following areas of regional Australia is considered eligible specified work for the purpose of a second or third Working Holiday (subclass 417) visa.<br><br>
        
        <strong>Primary Industry Work:</strong><br>
        • Agriculture, forestry and fishing<br>
        • Mining and construction<br>
        • Plant and animal cultivation<br>
        • Food processing and manufacturing<br><br>
        
        <strong>Key Features:</strong><br>
        • Traditional 88-day work areas<br>
        • Largest coverage area<br>
        • Most diverse work opportunities<br>
        • Year-round availability`
    },
    5: {
      title: "Bushfire Declared Areas (Table 5)",
      content: `<strong>Work Requirements:</strong><br><br>
        Bushfire recovery work carried out after <strong>31 July 2019</strong> in the following areas is considered specified work for the purpose of a second or third Working Holiday (subclass 417) visa.<br><br>
        
        <strong>Recovery Work Types:</strong><br>
        • Bushfire cleanup and debris removal<br>
        • Fencing and infrastructure repair<br>
        • Tree and vegetation management<br>
        • Soil conservation and rehabilitation<br>
        • Construction and rebuilding work<br><br>
        
        <strong>Important:</strong><br>
        • Work must be directly related to bushfire recovery<br>
        • Special documentation may be required<br>
        • Limited time availability`
    },
    6: {
      title: "Natural Disaster Declared Areas (Table 6)",
      content: `<strong>Work Requirements:</strong><br><br>
        Recovery work carried out from <strong>31 December 2021</strong> in the following areas of Australia, that have been declared affected by other natural disasters, such as flood, cyclones or other severe weather events, is considered eligible for specified work for the purpose of a second or third Working Holiday (subclass 417) visa.<br><br>
        
        <strong>Disaster Recovery Work:</strong><br>
        • Flood cleanup and water damage repair<br>
        • Cyclone damage restoration<br>
        • Emergency infrastructure repair<br>
        • Community recovery support<br>
        • Environmental rehabilitation<br><br>
        
        <strong>Application Requirements:</strong><br>
        This applies to applications lodged on or after <strong>5 April 2025</strong> and undecided applications on this date.`
    }
  };
  
  const data = tableData[tableNum];
  title.textContent = data.title;
  content.innerHTML = data.content;
  
  overlay.style.display = 'block';
  popup.style.display = 'block';
  
  // 3초 후 자동 닫기
  setTimeout(() => {
    closeTableDetail();
  }, 8000);
}

function closeTableDetail() {
  const popup = document.getElementById('table-detail-popup');
  const overlay = document.getElementById('popup-overlay');
  
  overlay.style.display = 'none';
  popup.style.display = 'none';
}

// 윈도우 리사이즈시 범례 상태 조정
window.addEventListener('resize', function() {
  const legend = document.getElementById('legend');
  const legendItems = document.querySelector('.legend-items');
  const toggleIcon = document.querySelector('.legend-toggle-icon');
  
  if (window.innerWidth <= 768) {
    if (!legend.classList.contains('legend-collapsed')) {
      legend.classList.add('legend-collapsed');
      legendItems.style.maxHeight = '0px';
      legendItems.style.opacity = '0';
      toggleIcon.textContent = '▶';
    }
  }
});

// 페이지 로드시 모바일이면 범례 접기
document.addEventListener('DOMContentLoaded', function() {
  if (window.innerWidth <= 768) {
    const legend = document.getElementById('legend');
    const legendItems = document.querySelector('.legend-items');
    const toggleIcon = document.querySelector('.legend-toggle-icon');
    
    legend.classList.add('legend-collapsed');
    legendItems.style.maxHeight = '0px';
    legendItems.style.opacity = '0';
    toggleIcon.textContent = '▶';
  }
});

/* 10. 지역별 댓글 시스템 */
let currentRegion = null;

function openCommentModal(postcode, name) {
  currentRegion = { postcode, name };
  
  document.getElementById('comment-modal-title').textContent = `Comments for ${name}, ${postcode}`;
  document.getElementById('comment-modal').style.display = 'flex';
  
  // 저장된 사용자 정보 불러오기
  const savedName = localStorage.getItem('commentUsername');
  if (savedName) {
    document.getElementById('comment-name').value = savedName;
  }
  
  // 기존 댓글 로드
  loadRegionComments(postcode);
}

function closeCommentModal() {
  document.getElementById('comment-modal').style.display = 'none';
  currentRegion = null;
  
  // 폼 초기화 (이름은 유지)
  document.getElementById('comment-password').value = '';
  document.getElementById('comment-text').value = '';
}

async function submitComment() {
  if (!currentRegion) return;
  
  const name = document.getElementById('comment-name').value.trim();
  const password = document.getElementById('comment-password').value.trim();
  const text = document.getElementById('comment-text').value.trim();
  
  if (!name || !password || !text) {
    alert('Please fill in all fields.');
    return;
  }
  
  if (name.length > 30 || password.length > 50 || text.length > 500) {
    alert('Input length exceeds the limit.');
    return;
  }
  
  // 사용자명 저장
  localStorage.setItem('commentUsername', name);
  
  const comment = {
    name: name,
    password: await hashPassword(password), // 보안 해시
    text: text,
    timestamp: Date.now(),
    postcode: currentRegion.postcode
  };
  
  if (window.commentsSystem && window.commentsSystem.enabled && window.firebaseDB) {
    // Firebase에 저장
    saveCommentToFirebase(comment);
  } else {
    // 로컬 스토리지에 저장
    saveCommentToLocal(comment);
    loadRegionComments(currentRegion.postcode);
  }
  
  // 새 댓글 추가 후 전체 댓글 목록 업데이트
  updateAllComments();
  
  // 폼 초기화 (이름은 유지)
  document.getElementById('comment-password').value = '';
  document.getElementById('comment-text').value = '';
}

function saveCommentToFirebase(comment) {
  const commentsRef = window.firebaseRef(window.firebaseDB, `regionComments/${comment.postcode}`);
  
  window.firebasePush(commentsRef, comment).then(() => {
    console.log('✅ Comment saved to Firebase');
    updateAllComments();
    showSuccessMessage('Comment posted successfully!', 'success');
  }).catch((error) => {
    console.error('❌ Firebase comment save error:', error);
    // Firebase 실패시 로컬 저장으로 폴백
    saveCommentToLocal(comment);
    loadRegionComments(currentRegion.postcode);
  });
}

function saveCommentToLocal(comment) {
  const key = `comments_${comment.postcode}`;
  const existing = JSON.parse(localStorage.getItem(key) || '[]');
  existing.push(comment);
  
  // 최대 100개 댓글만 유지
  if (existing.length > 100) {
    existing.splice(0, existing.length - 100);
  }
  
  localStorage.setItem(key, JSON.stringify(existing));
  showSuccessMessage('Comment posted successfully!', 'success');
}

function loadRegionComments(postcode) {
  if (window.commentsSystem && window.commentsSystem.enabled && window.firebaseDB) {
    // Firebase에서 로드
    const commentsRef = window.firebaseRef(window.firebaseDB, `regionComments/${postcode}`);
    
    window.firebaseOnValue(commentsRef, (snapshot) => {
      const data = snapshot.val();
      displayComments(data ? Object.values(data).sort((a, b) => b.timestamp - a.timestamp) : []);
    }, (error) => {
      console.error('❌ Firebase load error:', error);
      // Firebase 실패시 로컬에서 로드
      loadLocalComments(postcode);
    });
  } else {
    // 로컬 스토리지에서 로드
    loadLocalComments(postcode);
  }
}

function loadLocalComments(postcode) {
  const key = `comments_${postcode}`;
  const comments = JSON.parse(localStorage.getItem(key) || '[]');
  displayComments(comments.sort((a, b) => b.timestamp - a.timestamp));
}

function displayComments(comments) {
  const container = document.getElementById('comments-list');
  
  if (!comments || comments.length === 0) {
    container.innerHTML = '<div class="no-comments">No comments yet. Be the first to comment!</div>';
    return;
  }
  
  container.innerHTML = comments.map(comment => `
    <div class="comment-item" data-timestamp="${comment.timestamp}">
      <div class="comment-header">
        <div class="comment-author">${escapeHtml(comment.name)}</div>
        <div class="comment-time">
          ${new Date(comment.timestamp).toLocaleString()}
          ${comment.editedAt ? '<span style="color:#666;font-size:10px;"> (edited)</span>' : ''}
        </div>
      </div>
      <div class="comment-text">${escapeHtml(comment.text)}</div>
      <div class="comment-actions">
        <button class="btn-small btn-edit" onclick="editComment('${comment.timestamp}', '${escapeHtml(comment.name)}')">Edit</button>
        <button class="btn-small btn-delete" onclick="deleteComment('${comment.timestamp}', '${escapeHtml(comment.name)}')">Delete</button>
      </div>
    </div>
  `).join('');
}

async function editComment(timestamp, authorName) {
  const password = prompt('Enter your password:');
  if (!password) return;
  
  if (window.commentsSystem && window.commentsSystem.enabled && window.firebaseDB) {
    await editCommentFirebase(timestamp, password, authorName);
  } else {
    await editCommentLocal(timestamp, password, authorName);
  }
}

async function deleteComment(timestamp, authorName) {
  const password = prompt('Enter your password to delete:');
  if (!password) return;
  
  if (!confirm('Are you sure you want to delete this comment?')) return;
  
  if (window.commentsSystem && window.commentsSystem.enabled && window.firebaseDB) {
    await deleteCommentFirebase(timestamp, password, authorName);
  } else {
    await deleteCommentLocal(timestamp, password, authorName);
  }
}

async function editCommentFirebase(timestamp, password, authorName) {
  try {
    const commentsRef = window.firebaseRef(window.firebaseDB, `regionComments/${currentRegion.postcode}`);
    
    // Get data once instead of using listener
    const snapshot = await new Promise((resolve) => {
      window.firebaseOnValue(commentsRef, resolve, { once: true });
    });
    
    const data = snapshot.val();
    if (data) {
      const comments = Object.entries(data);
      const commentEntry = comments.find(([key, comment]) => comment.timestamp == timestamp);
      
      if (commentEntry && await verifyPassword(password, commentEntry[1].password)) {
        const newText = prompt('Enter new comment text:', commentEntry[1].text);
        if (newText && newText.trim() && newText.length <= 500) {
          const commentKey = commentEntry[0];
          const updatedComment = {
            ...commentEntry[1],
            text: newText.trim(),
            editedAt: Date.now()
          };
          
          const commentRef = window.firebaseRef(window.firebaseDB, `regionComments/${currentRegion.postcode}/${commentKey}`);
          await window.firebaseSet(commentRef, updatedComment);
          console.log('✅ Comment edited successfully');
          updateAllComments();
          showSuccessMessage('Comment updated successfully!', 'edit');
        }
      } else {
        alert('Incorrect password.');
      }
    }
  } catch (error) {
    console.error('❌ Edit failed:', error);
    alert('Failed to edit comment.');
  }
}

async function deleteCommentFirebase(timestamp, password, authorName) {
  try {
    const commentsRef = window.firebaseRef(window.firebaseDB, `regionComments/${currentRegion.postcode}`);
    
    // Get data once instead of using listener
    const snapshot = await new Promise((resolve) => {
      window.firebaseOnValue(commentsRef, resolve, { once: true });
    });
    
    const data = snapshot.val();
    if (data) {
      const comments = Object.entries(data);
      const commentEntry = comments.find(([key, comment]) => comment.timestamp == timestamp);
      
      if (commentEntry && await verifyPassword(password, commentEntry[1].password)) {
        const commentKey = commentEntry[0];
        const commentRef = window.firebaseRef(window.firebaseDB, `regionComments/${currentRegion.postcode}/${commentKey}`);
        
        await window.firebaseSet(commentRef, null);
        console.log('✅ Comment deleted successfully');
        updateAllComments();
        showSuccessMessage('Comment deleted successfully!', 'delete');
      } else {
        alert('Incorrect password.');
      }
    }
  } catch (error) {
    console.error('❌ Delete failed:', error);
    alert('Failed to delete comment.');
  }
}

async function editCommentLocal(timestamp, password, authorName) {
  const key = `comments_${currentRegion.postcode}`;
  const comments = JSON.parse(localStorage.getItem(key) || '[]');
  const comment = comments.find(c => c.timestamp == timestamp);
  
  if (comment && await verifyPassword(password, comment.password)) {
    const newText = prompt('Enter new comment text:', comment.text);
    if (newText && newText.trim() && newText.length <= 500) {
      comment.text = newText.trim();
      comment.editedAt = Date.now();
      localStorage.setItem(key, JSON.stringify(comments));
      loadRegionComments(currentRegion.postcode);
      updateAllComments();
      showSuccessMessage('Comment updated successfully!', 'edit');
    }
  } else {
    alert('Incorrect password.');
  }
}

async function deleteCommentLocal(timestamp, password, authorName) {
  const key = `comments_${currentRegion.postcode}`;
  const comments = JSON.parse(localStorage.getItem(key) || '[]');
  const commentIndex = comments.findIndex(c => c.timestamp == timestamp);
  
  if (commentIndex !== -1 && await verifyPassword(password, comments[commentIndex].password)) {
    comments.splice(commentIndex, 1);
    localStorage.setItem(key, JSON.stringify(comments));
    loadRegionComments(currentRegion.postcode);
    updateAllComments();
    showSuccessMessage('Comment deleted successfully!', 'delete');
  } else {
    alert('Incorrect password.');
  }
}


// 모달 외부 클릭시 닫기
document.addEventListener('click', function(e) {
  const modal = document.getElementById('comment-modal');
  if (e.target === modal) {
    closeCommentModal();
  }
});

// 댓글 안내 메시지
function showCommentInstruction() {
  const instruction = document.getElementById('comment-instruction');
  const doubleClickHint = document.getElementById('double-click-hint');
  
  if (!localStorage.getItem('commentInstructionShown')) {
    // 처음에는 작은 안내 메시지
    setTimeout(() => {
      instruction.classList.add('show');
      setTimeout(() => {
        instruction.classList.remove('show');
      }, 4000);
    }, 2000);
    
    // 5초 후 중앙에 큰 안내 메시지
    setTimeout(() => {
      doubleClickHint.style.display = 'block';
      setTimeout(() => {
        doubleClickHint.style.display = 'none';
      }, 3000);
    }, 6000);
    
    localStorage.setItem('commentInstructionShown', 'true');
  }
}

// 지역 클릭시 힌트 표시
function showDoubleClickHint() {
  const doubleClickHint = document.getElementById('double-click-hint');
  if (!localStorage.getItem('doubleClickHintShown')) {
    doubleClickHint.style.display = 'block';
    setTimeout(() => {
      doubleClickHint.style.display = 'none';
    }, 2000);
    localStorage.setItem('doubleClickHintShown', 'true');
  }
}

// 간단하지만 안전한 해시 함수 (Web Crypto API 사용)
async function hashPassword(password) {
  const encoder = new TextEncoder();
  const data = encoder.encode(password + 'salt_88days_map');
  const hashBuffer = await crypto.subtle.digest('SHA-256', data);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

async function verifyPassword(password, hash) {
  const newHash = await hashPassword(password);
  return newHash === hash;
}

// 전체 댓글 패널 기능
function toggleAllComments() {
  const panel = document.getElementById('all-comments-panel');
  if (panel.style.display === 'none' || panel.style.display === '') {
    panel.style.display = 'block';
    updateAllComments();
  } else {
    panel.style.display = 'none';
  }
}

function updateAllComments() {
  if (window.commentsSystem && window.commentsSystem.enabled && window.firebaseDB) {
    loadAllCommentsFromFirebase();
  } else {
    loadAllCommentsFromLocal();
  }
}

function loadAllCommentsFromFirebase() {
  const allCommentsRef = window.firebaseRef(window.firebaseDB, 'regionComments');
  
  window.firebaseOnValue(allCommentsRef, (snapshot) => {
    const data = snapshot.val();
    if (data) {
      const allComments = [];
      Object.keys(data).forEach(postcode => {
        Object.values(data[postcode]).forEach(comment => {
          allComments.push({
            ...comment,
            regionName: localityTable[postcode] || 'Unknown'
          });
        });
      });
      displayAllComments(allComments.sort((a, b) => b.timestamp - a.timestamp));
    } else {
      displayAllComments([]);
    }
  }, { once: true });
}

function loadAllCommentsFromLocal() {
  const allComments = [];
  
  // 모든 지역의 댓글을 수집
  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    if (key && key.startsWith('comments_')) {
      const postcode = key.replace('comments_', '');
      const comments = JSON.parse(localStorage.getItem(key) || '[]');
      comments.forEach(comment => {
        allComments.push({
          ...comment,
          regionName: localityTable[postcode] || 'Unknown'
        });
      });
    }
  }
  
  displayAllComments(allComments.sort((a, b) => b.timestamp - a.timestamp));
}

function displayAllComments(comments) {
  const container = document.getElementById('all-comments-list');
  
  if (!comments || comments.length === 0) {
    container.innerHTML = '<div class="no-all-comments">No comments yet.</div>';
    return;
  }
  
  // 최근 24시간 내 댓글을 "새 댓글"로 표시
  const oneDayAgo = Date.now() - (24 * 60 * 60 * 1000);
  
  container.innerHTML = comments.slice(0, 50).map(comment => {
    const isNew = comment.timestamp > oneDayAgo;
    return `
      <div class="all-comment-item">
        ${isNew ? '<div class="new-comment-badge">New</div>' : ''}
        <div class="all-comment-header">
          <div class="all-comment-region" onclick="goToRegion('${comment.postcode}', '${escapeHtml(comment.regionName)}')">${escapeHtml(comment.regionName)}, ${comment.postcode}</div>
          <div class="all-comment-meta">
            <div class="all-comment-author">By ${escapeHtml(comment.name)}</div>
            <div class="all-comment-time">${new Date(comment.timestamp).toLocaleString()}</div>
          </div>
        </div>
        <div class="all-comment-text">${escapeHtml(comment.text)}</div>
      </div>
    `;
  }).join('');
}

function goToRegion(postcode, regionName) {
  // 로딩 시작
  showNavigationLoading(regionName);
  
  // 전체 댓글 패널 닫기
  toggleAllComments();
  
  // 약간의 지연 후 지도 이동 (로딩 애니메이션을 보여주기 위해)
  setTimeout(() => {
    // 해당 지역으로 지도 이동
    geoLayer.eachLayer(layer => {
      if (layer.pcode === postcode) {
        // 지도 이동과 함께 부드러운 애니메이션
        map.flyTo(layer.getBounds().getCenter(), 10, {
          animate: true,
          duration: 1.5
        });
        
        // 지역 하이라이트
        highlightLayer(layer);
        
        // 하이라이트 애니메이션 추가
        setTimeout(() => {
          layer.getElement && layer.getElement().classList.add('region-highlight');
        }, 800);
        
        // 툴팁 표시
        setTimeout(() => {
          layer.openTooltip();
        }, 1200);
        
        // 로딩 완료 및 댓글 모달 열기
        setTimeout(() => {
          hideNavigationLoading();
          openCommentModal(postcode, regionName);
        }, 2000);
      }
    });
  }, 300);
}

// 네비게이션 로딩 표시
function showNavigationLoading(regionName) {
  const loadingElement = document.getElementById('navigation-loading');
  const regionNameElement = document.getElementById('loading-region-name');
  
  regionNameElement.textContent = `Finding ${regionName}...`;
  loadingElement.style.display = 'flex';
  
  // 로딩 텍스트 단계별 변경
  const loadingSteps = [
    `Finding ${regionName}...`,
    'Locating on map...',
    'Preparing region details...',
    'Almost ready!'
  ];
  
  let stepIndex = 0;
  const stepInterval = setInterval(() => {
    stepIndex++;
    if (stepIndex < loadingSteps.length) {
      regionNameElement.textContent = loadingSteps[stepIndex];
    } else {
      clearInterval(stepInterval);
    }
  }, 500);
  
  // 인터벌을 저장해서 나중에 정리할 수 있게 함
  loadingElement.stepInterval = stepInterval;
}

// 네비게이션 로딩 숨기기
function hideNavigationLoading() {
  const loadingElement = document.getElementById('navigation-loading');
  
  // 인터벌 정리
  if (loadingElement.stepInterval) {
    clearInterval(loadingElement.stepInterval);
    loadingElement.stepInterval = null;
  }
  
  // 페이드아웃 효과
  loadingElement.style.opacity = '0';
  loadingElement.style.transition = 'opacity 0.3s ease-out';
  
  setTimeout(() => {
    loadingElement.style.display = 'none';
    loadingElement.style.opacity = '1';
    loadingElement.style.transition = '';
  }, 300);
}
</script>
</body>
</html>