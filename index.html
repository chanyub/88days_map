<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Postcode Polygons (POA 2021)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    html,body,#map{height:100%;margin:0}
    #search-container{position:absolute;top:10px;left:50%;transform:translateX(-50%);z-index:1000;background:white;padding:10px;border-radius:5px;box-shadow:0 2px 5px rgba(0,0,0,0.2)}
    #search-input{padding:5px;width:200px;border:1px solid #ccc;border-radius:3px}
    #search-results{max-height:200px;overflow-y:auto;background:white;border:1px solid #ccc;border-top:none;display:none}
    .search-result{padding:8px;cursor:pointer;border-bottom:1px solid #eee}
    .search-result:hover{background:#f0f0f0}
    #visitor-stats{position:absolute;bottom:10px;right:10px;z-index:1000;background:rgba(255,255,255,0.9);padding:8px;border-radius:5px;font-size:12px;font-family:Arial,sans-serif}
    .stat-line{margin:2px 0}
    #legend{position:absolute;top:60px;left:10px;z-index:1000;background:rgba(255,255,255,0.95);padding:15px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,0.3);max-width:350px;font-family:Arial,sans-serif;font-size:13px}
    .legend-title{font-weight:bold;font-size:16px;margin-bottom:10px;color:#333}
    .legend-item{display:flex;align-items:center;margin:8px 0;cursor:pointer}
    .legend-item:hover{background:#f5f5f5;border-radius:4px;padding:4px}
    .legend-color{width:20px;height:15px;margin-right:10px;border:1px solid #333;border-radius:3px}
    .legend-text{flex:1;line-height:1.3}
    .legend-category{font-weight:bold;color:#444}
    .legend-source{margin-top:15px;padding-top:10px;border-top:1px solid #ddd;font-size:11px;color:#666}
    .legend-source a{color:#0066cc;text-decoration:none}
    .legend-source a:hover{text-decoration:underline}
    #info-panel{position:absolute;top:10px;right:10px;z-index:1001;background:rgba(255,255,255,0.95);padding:15px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,0.3);max-width:400px;font-family:Arial,sans-serif;font-size:13px;display:none}
    .info-title{font-weight:bold;font-size:16px;margin-bottom:10px;color:#333}
    .info-content{line-height:1.5}
    .close-btn{float:right;cursor:pointer;font-size:18px;color:#666}
    .close-btn:hover{color:#000}
    #loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:9999;display:flex;justify-content:center;align-items:center;color:white;font-family:Arial,sans-serif}
    .spinner{border:4px solid #f3f3f3;border-top:4px solid #3498db;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin-right:15px}
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
    .loading-text{font-size:18px}
    #chat-container{position:absolute;bottom:10px;left:10px;z-index:1000;width:300px;background:rgba(255,255,255,0.95);border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,0.3);font-family:Arial,sans-serif;font-size:12px}
    #chat-header{background:#4a90e2;color:white;padding:8px 12px;border-radius:8px 8px 0 0;font-weight:bold;cursor:pointer;user-select:none}
    #chat-content{display:none;max-height:200px;border:1px solid #ddd;border-top:none}
    #chat-messages{height:150px;overflow-y:auto;padding:8px;background:white}
    .message{margin:4px 0;padding:4px 6px;background:#f8f9fa;border-radius:4px;word-wrap:break-word}
    .message-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:2px}
    .message-author{font-weight:bold;color:#333;font-size:11px}
    .message-time{font-size:10px;color:#666}
    .message-text{font-size:11px;line-height:1.3}
    #chat-input-container{padding:8px;background:#f5f5f5;border-radius:0 0 8px 8px}
    .input-row{display:flex;gap:5px;margin-bottom:5px}
    #username-input{width:80px;padding:4px;border:1px solid #ddd;border-radius:3px;font-size:11px}
    #chat-input{flex:1;padding:4px;border:1px solid #ddd;border-radius:3px;font-size:11px}
    #chat-send{padding:4px 8px;background:#4a90e2;color:white;border:none;border-radius:3px;cursor:pointer;font-size:11px}
    #chat-send:hover{background:#357abd}
    .chat-collapsed{opacity:0.8}
    #creator-info{position:absolute;bottom:10px;right:130px;z-index:1000;background:rgba(255,255,255,0.9);padding:6px 8px;border-radius:5px;font-size:10px;font-family:Arial,sans-serif;color:#666;box-shadow:0 1px 3px rgba(0,0,0,0.2)}
    #creator-info a{color:#4a90e2;text-decoration:none;margin:0 2px}
    #creator-info a:hover{text-decoration:underline}
    .creator-line{margin:1px 0}
  </style>
</head>
<body>
<div id="loading-overlay">
  <div class="spinner"></div>
  <div class="loading-text">Loading map data...</div>
</div>
<div id="search-container">
  <input type="text" id="search-input" placeholder="Search postcode or locality">
  <div id="search-results"></div>
</div>

<div id="legend">
  <div class="legend-title">Working Holiday 88-Day Areas</div>
  <div class="legend-item" onclick="showInfo(1)">
    <div class="legend-color" style="background:#ff0000"></div>
    <div class="legend-text">
      <div class="legend-category">Remote/Very Remote Australia (Table 1)</div>
      <div>Tourism and hospitality work (from 22 June 2021)</div>
    </div>
  </div>
  <div class="legend-item" onclick="showInfo(2)">
    <div class="legend-color" style="background:#ff8c00"></div>
    <div class="legend-text">
      <div class="legend-category">Australia (Table 2)</div>
      <div>Tourism and hospitality work (from 22 June 2021)</div>
    </div>
  </div>
  <div class="legend-item" onclick="showInfo(3)">
    <div class="legend-color" style="background:#ffff00"></div>
    <div class="legend-text">
      <div class="legend-category">Northern Australia (Table 3)</div>
      <div>Tourism and hospitality work (from 22 June 2021)</div>
    </div>
  </div>
  <div class="legend-item" onclick="showInfo(4)">
    <div class="legend-color" style="background:#32cd32"></div>
    <div class="legend-text">
      <div class="legend-category">Regional Australia (Table 4)</div>
      <div>Specified work (Primary industries)</div>
    </div>
  </div>
  <div class="legend-item" onclick="showInfo(5)">
    <div class="legend-color" style="background:#0078ff"></div>
    <div class="legend-text">
      <div class="legend-category">Bushfire Declared Areas (Table 5)</div>
      <div>Bushfire recovery work (after 31 July 2019)</div>
    </div>
  </div>
  <div class="legend-item" onclick="showInfo(6)">
    <div class="legend-color" style="background:#9370db"></div>
    <div class="legend-text">
      <div class="legend-category">Natural Disaster Declared Areas (Table 6)</div>
      <div>Natural disaster recovery work (from 31 Dec 2021)</div>
    </div>
  </div>
  
  <div class="legend-source">
    <strong>Source:</strong> Australian Department of Home Affairs<br>
    For detailed information, please refer to:<br>
    <a href="https://immi.homeaffairs.gov.au/what-we-do/whm-program/specified-work-conditions/specified-work-417" target="_blank">
      Official Specified Work Requirements
    </a>
  </div>
</div>

<div id="info-panel">
  <span class="close-btn" onclick="hideInfo()">&times;</span>
  <div class="info-title" id="info-title"></div>
  <div class="info-content" id="info-content"></div>
</div>

<div id="visitor-stats">
  <div class="stat-line">Total Visitors: <span id="total-visitors">0</span></div>
  <div class="stat-line">Today's Visitors: <span id="today-visitors">0</span></div>
</div>

<div id="creator-info">
  <div class="creator-line">üìç Created by <strong>ÌïòÍ≥†Ïã∂ÏùÄÍ≤åÎßéÏùÄüá∞üá∑</strong></div>
  <div class="creator-line">üìß <a href="#" onclick="copyEmail(event)">Contact</a> | üì∫ <a href="https://www.youtube.com/@%ED%95%98%EA%B3%A0%EC%8B%B6%EC%9D%80%EA%B2%8C%EB%A7%8E%EC%9D%80" target="_blank">YouTube</a></div>
</div>

<div id="chat-container" class="chat-collapsed">
  <div id="chat-header" onclick="toggleChat()">üí¨ Guestbook</div>
  <div id="chat-content">
    <div id="chat-messages"></div>
    <div id="chat-input-container">
      <div class="input-row">
        <input type="text" id="username-input" placeholder="Name" maxlength="20">
        <input type="text" id="chat-input" placeholder="Leave a message..." maxlength="200">
      </div>
      <button id="chat-send" onclick="sendMessage()" style="width:100%;margin-top:2px;">Send</button>
    </div>
  </div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* 1. ÏßÄÎèÑ */
const map = L.map('map').setView([-27, 133], 5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution:'¬© OpenStreetMap contributors'
}).addTo(map);

/* 2. POA Ìè¥Î¶¨Í≥§ Î∂àÎü¨Ïò§Í∏∞ */
let localityTable = {}; // postcode ‚Üí locality
let geoLayer; // Í≤ÄÏÉâÏùÑ ÏúÑÌï¥ Ï†ÄÏû•
let highlightedLayer = null; // ÌòÑÏû¨ Í∞ïÏ°∞Îêú Î†àÏù¥Ïñ¥
let table1Postcodes = new Set(); // table 1 (Îπ®Í∞ÑÏÉâ)
let table2Postcodes = new Set(); // table 2 (Ï£ºÌô©ÏÉâ)
let table3Postcodes = new Set(); // table 3 (ÎÖ∏ÎûÄÏÉâ)
let table4Postcodes = new Set(); // table 4 (Ï¥àÎ°ùÏÉâ)
let table5Postcodes = new Set(); // table 5 (ÌååÎûÄÏÉâ)
let table6Postcodes = new Set(); // table 6 (Î≥¥ÎùºÏÉâ)

// CSV ÌååÏùºÎì§ÏóêÏÑú Ïö∞Ìé∏Î≤àÌò∏ ÌååÏã±
function parsePostcodes(postcodeStr) {
  const postcodes = [];
  const parts = postcodeStr.split(',').map(s => s.trim());
  
  for (let part of parts) {
    if (part.includes(' to ')) {
      const [start, end] = part.split(' to ').map(s => parseInt(s.trim()));
      for (let i = start; i <= end; i++) {
        postcodes.push(i.toString());
      }
    } else {
      postcodes.push(part);
    }
  }
  return postcodes;
}

// Ï†ÑÏ≤¥ Ï£º/ÌÖåÎ¶¨ÌÜ†Î¶¨ Ïö∞Ìé∏Î≤àÌò∏ Ï∂îÍ∞Ä Ìï®Ïàò
function addAllPostcodes(state, targetSet) {
  if (state.includes('Northern Territory') || state.includes('ACT')) {
    for (let i = 800; i <= 999; i++) {
      targetSet.add('0' + i);
    }
    for (let i = 200; i <= 299; i++) {
      targetSet.add('0' + i);
    }
  } else if (state.includes('South Australia')) {
    for (let i = 5000; i <= 5999; i++) {
      targetSet.add(i.toString());
    }
  } else if (state.includes('Tasmania')) {
    for (let i = 7000; i <= 7999; i++) {
      targetSet.add(i.toString());
    }
  } else if (state.includes('Norfolk Island')) {
    targetSet.add('2899');
  }
}

Promise.all([
  fetch('postcode2name.json').then(r => r.json()),
  Promise.all([
    "data/geo_chunk_0.json", "data/geo_chunk_1.json", "data/geo_chunk_2.json", "data/geo_chunk_3.json", 
    "data/geo_chunk_4.json", "data/geo_chunk_5.json", "data/geo_chunk_6.json", "data/geo_chunk_7.json",
    "data/geo_chunk_8.json", "data/geo_chunk_9.json", "data/geo_chunk_10.json", "data/geo_chunk_11.json",
    "data/geo_chunk_12.json", "data/geo_chunk_13.json", "data/geo_chunk_14.json", "data/geo_chunk_15.json",
    "data/geo_chunk_16.json", "data/geo_chunk_17.json", "data/geo_chunk_18.json", "data/geo_chunk_19.json",
    "data/geo_chunk_20.json", "data/geo_chunk_21.json", "data/geo_chunk_22.json", "data/geo_chunk_23.json",
    "data/geo_chunk_24.json", "data/geo_chunk_25.json", "data/geo_chunk_26.json"
  ].map(file => fetch(file).then(r => r.json()))
  ).then(chunks => {
    const allFeatures = [];
    chunks.forEach(chunk => allFeatures.push(...chunk.features));
    return { type: 'FeatureCollection', features: allFeatures };
  }),
  fetch('data/table1.csv').then(r => r.text()),
  fetch('data/table2.csv').then(r => r.text()),
  fetch('data/table3.csv').then(r => r.text()),
  fetch('data/table4.csv').then(r => r.text()),
  fetch('data/table5.csv').then(r => r.text()),
  fetch('data/table6.csv').then(r => r.text())
])
.then(([nameMap, geo, table1, table2, table3, table4, table5, table6]) => {
  localityTable = nameMap;
  
  // Í∞Å ÌÖåÏù¥Î∏îÏóêÏÑú Ïö∞Ìé∏Î≤àÌò∏ Ï∂îÏ∂ú
  const tableSets = [table1Postcodes, table2Postcodes, table3Postcodes, table4Postcodes, table5Postcodes, table6Postcodes];
  const csvFiles = [table1, table2, table3, table4, table5, table6];
  
  csvFiles.forEach((csvText, tableIndex) => {
    const lines = csvText.split('\n').slice(1);
    lines.forEach(line => {
      if (line.trim()) {
        const firstCommaIndex = line.indexOf(',');
        if (firstCommaIndex > 0) {
          const state = line.substring(0, firstCommaIndex).trim();
          const postcodes = line.substring(firstCommaIndex + 1).trim().replace(/"/g, '');
          
          if (postcodes && !postcodes.includes('All') && postcodes !== 'All areas.') {
            const codes = postcodes.split(',').map(s => s.trim()).filter(s => s);
            codes.forEach(code => tableSets[tableIndex].add(code));
          } else if (postcodes && (postcodes.includes('All') || postcodes === 'All areas.')) {
            addAllPostcodes(state, tableSets[tableIndex]);
          }
        }
      }
    });
  });
  
  // ÏÉâÏÉÅ Ï†ïÏùò
  const tableColors = ['#ff0000', '#ff8c00', '#ffff00', '#32cd32', '#0078ff', '#9370db']; // Îπ®Í∞ï, Ï£ºÌô©, ÎÖ∏Îûë, ÎùºÏûÑÍ∑∏Î¶∞, ÌååÎûë, Î≥¥Îùº
  
  geoLayer = L.geoJSON(geo, {
    style: (feature) => {
      const pcode = feature.properties.POA_CODE_2021;
      
      // Í∞Å ÌÖåÏù¥Î∏î ÏàúÏÑúÎåÄÎ°ú ÌôïÏù∏
      for (let i = 0; i < tableSets.length; i++) {
        if (tableSets[i].has(pcode)) {
          return { color: tableColors[i], weight: 1, fillOpacity: 0.5 };
        }
      }
      
      // Ïñ¥Îñ§ ÌÖåÏù¥Î∏îÏóêÎèÑ ÏóÜÏúºÎ©¥ Í∏∞Î≥∏ ÌååÎûÄÏÉâ
      return { color: '#87ceeb', weight: 1, fillOpacity: 0.3 };
    },
    onEachFeature: (feature, layer) => {
      const pcode = feature.properties.POA_CODE_2021;
      const name  = localityTable[pcode] || 'Unknown';
      layer.bindTooltip(`${name}, ${pcode}`, { sticky: true });
      layer.pcode = pcode;
      layer.name = name;
      
      // ÏõêÎûò Ïä§ÌÉÄÏùº Ï†ÄÏû•
      let originalColor = '#87ceeb';
      for (let i = 0; i < tableSets.length; i++) {
        if (tableSets[i].has(pcode)) {
          originalColor = tableColors[i];
          break;
        }
      }
      layer.originalStyle = { color: originalColor, weight: 1, fillOpacity: 0.5 };
      
      // Ìè¥Î¶¨Í≥§ ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Ï∂îÍ∞Ä
      layer.on('click', function(e) {
        highlightLayer(layer);
        L.DomEvent.stopPropagation(e);
      });
    }
  }).addTo(map);
  
  setupSearch();
  initVisitorStats();
  
  // Î°úÎî© ÏôÑÎ£å ÌõÑ Ïò§Î≤ÑÎ†àÏù¥ Ïà®Í∏∞Í∏∞
  document.getElementById('loading-overlay').style.display = 'none';
  
  // Ï±ÑÌåÖ Ï¥àÍ∏∞Ìôî
  initChat();
})
.catch(err => {
  console.error('Ï†ÑÏ≤¥ Î°úÎî© Ïã§Ìå®:', err);
  alert('Î°úÎî© Ïã§Ìå®: ' + err.message);
});

/* 5. Î∞©Î¨∏Ïûê ÌÜµÍ≥Ñ Í∏∞Îä• */
function initVisitorStats() {
  const today = new Date().toDateString();
  
  // Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄÏóêÏÑú Î∞©Î¨∏Ïûê Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
  let totalVisitors = parseInt(localStorage.getItem('totalVisitors') || '0');
  let todayVisitors = parseInt(localStorage.getItem('todayVisitors') || '0');
  let lastVisitDate = localStorage.getItem('lastVisitDate') || '';
  
  // Ïò§Îäò Ï≤´ Î∞©Î¨∏Ïù∏ÏßÄ ÌôïÏù∏
  if (lastVisitDate !== today) {
    todayVisitors = 0;
    localStorage.setItem('lastVisitDate', today);
  }
  
  // Î∞©Î¨∏Ïûê Ïàò Ï¶ùÍ∞Ä
  totalVisitors += 1;
  todayVisitors += 1;
  
  // Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄÏóê Ï†ÄÏû•
  localStorage.setItem('totalVisitors', totalVisitors.toString());
  localStorage.setItem('todayVisitors', todayVisitors.toString());
  
  // ÌôîÎ©¥Ïóê ÌëúÏãú
  document.getElementById('total-visitors').textContent = totalVisitors.toLocaleString();
  document.getElementById('today-visitors').textContent = todayVisitors.toLocaleString();
}

/* 6. Ï†ïÎ≥¥ Ìå®ÎÑê Í∏∞Îä• */
function showInfo(tableNum) {
  const infoData = {
    1: {
      title: "Remote and Very Remote Australia (Table 1)",
      content: `<strong>Work Requirements:</strong><br>
        Tourism and hospitality work carried out from 22 June 2021 in the following areas of Remote and Very Remote Australia is considered eligible specified work for the purpose of a second or third Working Holiday (subclass 417) visa application lodged from 5 March 2022.`
    },
    2: {
      title: "Australia (Table 2)",
      content: `<strong>Work Requirements:</strong><br>
        Tourism and hospitality work carried out from 22 June 2021 in the following areas of Australia is considered eligible specified work for the purpose of a second or third Working Holiday (subclass 417) visa application lodged from 1 July 2022.`
    },
    3: {
      title: "Northern Australia (Table 3)",
      content: `<strong>Work Requirements:</strong><br>
        Tourism and hospitality work carried out from 22 June 2021 in the following areas of Northern Australia is considered eligible specified work for the purpose of a second or third Working Holiday (subclass 417) visa application lodged from 5 March 2022.`
    },
    4: {
      title: "Regional Australia (Table 4)",
      content: `<strong>Work Requirements:</strong><br>
        Specified work carried out in the following areas of regional Australia is considered eligible specified work for the purpose of a second or third Working Holiday (subclass 417) visa.`
    },
    5: {
      title: "Bushfire Declared Areas (Table 5)",
      content: `<strong>Work Requirements:</strong><br>
        Bushfire recovery work carried out after 31 July 2019 in the following areas is considered specified work for the purpose of a second or third Working Holiday (subclass 417) visa.`
    },
    6: {
      title: "Natural Disaster Declared Areas (Table 6)",
      content: `<strong>Work Requirements:</strong><br>
        Recovery work carried out from 31 December 2021 in the following areas of Australia, that have been declared affected by other natural disasters, such as flood, cyclones or other severe weather events, is considered eligible for specified work for the purpose of a second or third Working Holiday (subclass 417) visa.<br><br>
        <strong>Application Requirements:</strong><br>
        This applies to applications lodged on or after 5 April 2025 and undecided applications on this date.`
    }
  };

  const info = infoData[tableNum];
  document.getElementById('info-title').textContent = info.title;
  document.getElementById('info-content').innerHTML = info.content;
  document.getElementById('info-panel').style.display = 'block';
}

function hideInfo() {
  document.getElementById('info-panel').style.display = 'none';
}

/* 3. Í≤ÄÏÉâ Í∏∞Îä• */
function setupSearch() {
  const searchInput = document.getElementById('search-input');
  const searchResults = document.getElementById('search-results');
  
  searchInput.addEventListener('input', function() {
    const query = this.value.trim();
    if (query.length < 2) {
      searchResults.style.display = 'none';
      return;
    }
    
    const results = [];
    geoLayer.eachLayer(layer => {
      const pcode = layer.pcode;
      const name = layer.name;
      if (pcode.includes(query) || name.toLowerCase().includes(query.toLowerCase())) {
        results.push({ pcode, name, layer });
      }
    });
    
    if (results.length > 0) {
      searchResults.innerHTML = results.slice(0, 10).map(result => 
        `<div class="search-result" data-pcode="${result.pcode}">${result.name}, ${result.pcode}</div>`
      ).join('');
      searchResults.style.display = 'block';
    } else {
      searchResults.style.display = 'none';
    }
  });
  
  searchResults.addEventListener('click', function(e) {
    if (e.target.classList.contains('search-result')) {
      const pcode = e.target.dataset.pcode;
      geoLayer.eachLayer(layer => {
        if (layer.pcode === pcode) {
          highlightLayer(layer);
          map.fitBounds(layer.getBounds());
          layer.openTooltip();
        }
      });
      searchResults.style.display = 'none';
      searchInput.value = '';
    }
  });
  
  document.addEventListener('click', function(e) {
    if (!e.target.closest('#search-container')) {
      searchResults.style.display = 'none';
    }
  });
}

/* 4. Î†àÏù¥Ïñ¥ Í∞ïÏ°∞ Í∏∞Îä• */
function highlightLayer(layer) {
  // Ïù¥Ï†Ñ Í∞ïÏ°∞ Ìï¥Ï†ú
  if (highlightedLayer) {
    highlightedLayer.setStyle(highlightedLayer.originalStyle);
  }
  
  // ÏõêÎûò ÏÉâÏÉÅÏùÑ Îçî ÏßÑÌïòÍ≤å ÎßåÎì§Ïñ¥ Í∞ïÏ°∞
  const originalColor = layer.originalStyle.color;
  const darkerColor = getDarkerColor(originalColor);
  
  layer.setStyle({
    color: darkerColor,
    weight: 3,
    fillOpacity: 0.8
  });
  
  highlightedLayer = layer;
}

// ÏÉâÏÉÅÏùÑ Îçî ÏßÑÌïòÍ≤å ÎßåÎìúÎäî Ìï®Ïàò
function getDarkerColor(hexColor) {
  const colorMap = {
    '#ff0000': '#cc0000', // Îπ®Í∞ÑÏÉâ -> Îçî ÏßÑÌïú Îπ®Í∞ÑÏÉâ
    '#ff8c00': '#e6660a', // Ï£ºÌô©ÏÉâ -> Îçî ÏßÑÌïú Ï£ºÌô©ÏÉâ
    '#ffff00': '#cccc00', // ÎÖ∏ÎûÄÏÉâ -> Îçî ÏßÑÌïú ÎÖ∏ÎûÄÏÉâ
    '#32cd32': '#228b22', // ÎùºÏûÑÍ∑∏Î¶∞ -> Îçî ÏßÑÌïú Ï¥àÎ°ùÏÉâ
    '#0078ff': '#0056cc', // ÌååÎûÄÏÉâ -> Îçî ÏßÑÌïú ÌååÎûÄÏÉâ
    '#9370db': '#7b68ee', // Î≥¥ÎùºÏÉâ -> Îçî ÏßÑÌïú Î≥¥ÎùºÏÉâ
    '#87ceeb': '#5f9ea0'  // Ïó∞Ìïú ÌååÎûÄÏÉâ -> Îçî ÏßÑÌïú ÌååÎûÄÏÉâ
  };
  
  return colorMap[hexColor] || hexColor;
}

// ÏßÄÎèÑ ÌÅ¥Î¶≠Ïãú Í∞ïÏ°∞ Ìï¥Ï†ú
map.on('click', function(e) {
  if (highlightedLayer) {
    highlightedLayer.setStyle(highlightedLayer.originalStyle);
    highlightedLayer = null;
  }
});

/* 7. Í∞ÑÎã®Ìïú Ï±ÑÌåÖ/Î∞©Î™ÖÎ°ù Í∏∞Îä• */
function initChat() {
  loadMessages();
  
  // Enter ÌÇ§Î°ú Î©îÏãúÏßÄ Ï†ÑÏÜ°
  document.getElementById('chat-input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      sendMessage();
    }
  });
  
  document.getElementById('username-input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      document.getElementById('chat-input').focus();
    }
  });
}

function toggleChat() {
  const content = document.getElementById('chat-content');
  const container = document.getElementById('chat-container');
  
  if (content.style.display === 'none' || content.style.display === '') {
    content.style.display = 'block';
    container.classList.remove('chat-collapsed');
  } else {
    content.style.display = 'none';
    container.classList.add('chat-collapsed');
  }
}

function sendMessage() {
  const input = document.getElementById('chat-input');
  const usernameInput = document.getElementById('username-input');
  const message = input.value.trim();
  const username = usernameInput.value.trim() || 'Anonymous';
  
  if (message) {
    const timestamp = new Date().toLocaleString();
    const messageObj = {
      text: message,
      author: username,
      time: timestamp
    };
    
    // ÏÇ¨Ïö©ÏûêÎ™ÖÏùÑ Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄÏóê Ï†ÄÏû• (Îã§ÏùåÏóê ÏûêÎèô ÏûÖÎ†•)
    localStorage.setItem('guestbookUsername', username);
    
    // Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄÏóê Ï†ÄÏû•
    const messages = getMessages();
    messages.push(messageObj);
    
    // ÏµúÎåÄ 50Í∞ú Î©îÏãúÏßÄÎßå Ïú†ÏßÄ
    if (messages.length > 50) {
      messages.splice(0, messages.length - 50);
    }
    
    localStorage.setItem('guestbookMessages', JSON.stringify(messages));
    
    // ÌôîÎ©¥Ïóê ÌëúÏãú
    addMessageToChat(messageObj);
    
    // Î©îÏãúÏßÄ ÏûÖÎ†•Ï∞ΩÎßå ÎπÑÏö∞Í∏∞ (ÏÇ¨Ïö©ÏûêÎ™ÖÏùÄ Ïú†ÏßÄ)
    input.value = '';
    
    // Ïä§ÌÅ¨Î°§ÏùÑ ÏïÑÎûòÎ°ú
    const messagesContainer = document.getElementById('chat-messages');
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }
}

function getMessages() {
  const stored = localStorage.getItem('guestbookMessages');
  return stored ? JSON.parse(stored) : [];
}

function loadMessages() {
  const messages = getMessages();
  const container = document.getElementById('chat-messages');
  
  container.innerHTML = '';
  
  // Ï†ÄÏû•Îêú ÏÇ¨Ïö©ÏûêÎ™Ö Î∂àÎü¨Ïò§Í∏∞
  const savedUsername = localStorage.getItem('guestbookUsername');
  if (savedUsername) {
    document.getElementById('username-input').value = savedUsername;
  }
  
  if (messages.length === 0) {
    container.innerHTML = '<div style="color:#999;text-align:center;padding:20px;">No messages yet. Be the first to leave a message!</div>';
  } else {
    messages.forEach(msg => addMessageToChat(msg));
    container.scrollTop = container.scrollHeight;
  }
}

function addMessageToChat(messageObj) {
  const container = document.getElementById('chat-messages');
  const messageDiv = document.createElement('div');
  messageDiv.className = 'message';
  
  // Ï≤´ Î≤àÏß∏ Î©îÏãúÏßÄÏù∏ Í≤ΩÏö∞ ÌôòÏòÅ Î©îÏãúÏßÄ Ï†úÍ±∞
  if (container.querySelector('[style*="color:#999"]')) {
    container.innerHTML = '';
  }
  
  messageDiv.innerHTML = `
    <div class="message-header">
      <div class="message-author">${escapeHtml(messageObj.author || 'Anonymous')}</div>
      <div class="message-time">${messageObj.time}</div>
    </div>
    <div class="message-text">${escapeHtml(messageObj.text)}</div>
  `;
  
  container.appendChild(messageDiv);
}

// HTML Ïù¥Ïä§ÏºÄÏù¥ÌîÑ Ìï®Ïàò
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

/* 8. Ïù¥Î©îÏùº Î≥µÏÇ¨ Í∏∞Îä• */
function copyEmail(event) {
  event.preventDefault();
  const email = 'somanytube@gmail.com';
  
  // ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨
  navigator.clipboard.writeText(email).then(function() {
    // Î≥µÏÇ¨ ÏÑ±Í≥µ Î©îÏãúÏßÄ ÌëúÏãú
    showCopyMessage('üìß Email copied to clipboard!');
  }).catch(function() {
    // ÎåÄÏ≤¥ Î∞©Î≤ï (Íµ¨Î†® Î∏åÎùºÏö∞Ï†Ä)
    const textArea = document.createElement('textarea');
    textArea.value = email;
    document.body.appendChild(textArea);
    textArea.select();
    document.execCommand('copy');
    document.body.removeChild(textArea);
    showCopyMessage('üìß Email copied to clipboard!');
  });
}

function showCopyMessage(message) {
  // Í∏∞Ï°¥ Î©îÏãúÏßÄÍ∞Ä ÏûàÏúºÎ©¥ Ï†úÍ±∞
  const existingMsg = document.getElementById('copy-message');
  if (existingMsg) {
    existingMsg.remove();
  }
  
  // Î©îÏãúÏßÄ ÏóòÎ¶¨Î®ºÌä∏ ÏÉùÏÑ±
  const messageDiv = document.createElement('div');
  messageDiv.id = 'copy-message';
  messageDiv.textContent = message;
  messageDiv.style.cssText = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(74, 144, 226, 0.9);
    color: white;
    padding: 12px 20px;
    border-radius: 6px;
    font-size: 14px;
    font-family: Arial, sans-serif;
    z-index: 10000;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    animation: fadeInOut 2s ease-in-out;
  `;
  
  // CSS Ïï†ÎãàÎ©îÏù¥ÏÖò Ï∂îÍ∞Ä
  if (!document.getElementById('copy-animation-style')) {
    const style = document.createElement('style');
    style.id = 'copy-animation-style';
    style.textContent = `
      @keyframes fadeInOut {
        0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
        20% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
      }
    `;
    document.head.appendChild(style);
  }
  
  document.body.appendChild(messageDiv);
  
  // 2Ï¥à ÌõÑ ÏûêÎèô Ï†úÍ±∞
  setTimeout(() => {
    if (messageDiv.parentNode) {
      messageDiv.remove();
    }
  }, 2000);
}
</script>
</body>
</html>